<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleCode Analytics Enterprise Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; font-size: 13px; color: #1e293b; }
        
        .table-container { height: 320px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: #f8fafc; z-index: 20; border-bottom: 1px solid #e2e8f0; padding: 12px 10px; font-size: 0.75rem; color: #64748b; font-weight: 700; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        
        .section-title { font-size: 0.95rem; font-weight: 800; margin-bottom: 0.75rem; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        
        .selected-online { background-color: #eff6ff !important; font-weight: 700; color: #1d4ed8; border-left: 4px solid #3b82f6; }
        .selected-offline { background-color: #fef2f2 !important; font-weight: 700; color: #b91c1c; border-left: 4px solid #ef4444; }
        .selected-customer { background-color: #f5f3ff !important; font-weight: 700; color: #7c3aed; border-left: 4px solid #8b5cf6; }
        .selected-total { background-color: #f1f5f9 !important; font-weight: 700; color: #0f172a; border-left: 4px solid #475569; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background-color: #f8fafc; }
        
        .btn-toggle { padding: 5px 12px; font-size: 0.7rem; font-weight: 700; border-radius: 6px; transition: all 0.2s; }
        .btn-active { background-color: white; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn-inactive { color: #94a3b8; border: 1px solid transparent; }
        .control-group { background-color: #e2e8f0; padding: 3px; border-radius: 8px; display: flex; gap: 2px; }
        
        .group-header { border-bottom: 4px solid #0f172a; padding-bottom: 0.75rem; margin: 3rem 0 1.5rem 0; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 9999px; font-weight: 800; }

        .select2-container { width: 100% !important; }
        .select2-selection--multiple { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; padding: 2px 6px !important; background-color: #f8fafc !important; }
        .select2-selection--single { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; background-color: #f8fafc !important; min-height: 42px !important; display: flex !important; align-items: center !important; }
        .select2-selection__rendered { font-weight: 800 !important; color: #0f172a !important; padding-left: 12px !important; }
        .select2-selection__arrow { height: 40px !important; }
        .select2-dropdown { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; }
        .select2-results__option { padding: 8px 12px !important; font-weight: 600 !important; }
        .select2-results__option--highlighted { background-color: #0f172a !important; color: white !important; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-[1600px] mx-auto">
        
        <header class="mb-8">
            <div>
                <h1 class="text-4xl font-black tracking-tight text-slate-900 mb-2">
                    StyleCode Data Lab 
                    <span class="text-blue-600 bg-blue-50 px-3 py-1 rounded-lg inline-block ml-2">v2.9</span>
                </h1>
                <p class="text-slate-600 font-semibold text-lg">스타일 판매 성과 분석 통합 대시보드</p>
            </div>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Brand</label>
                    <select id="brand-filter" class="js-brand-filter">
                        <option value="전체">전체</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">품번 (PART_CD)</label>
                    <select id="part-filter" class="js-part-filter" multiple="multiple">
                    </select>
                </div>
                <div class="md:col-span-5" id="date-range">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Analysis Period</label>
                    <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2">
                        <input type="date" id="startDate" class="bg-transparent font-bold text-xs outline-none cursor-pointer flex-1">
                        <span class="text-slate-300 font-bold">~</span>
                        <input type="date" id="endDate" class="bg-transparent font-bold text-xs outline-none cursor-pointer flex-1">
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="updateDashboard()" class="bg-slate-900 text-white px-10 py-3 rounded-xl font-bold hover:bg-slate-800 transition transform active:scale-95 shadow-xl">조회하기</button>
            </div>
        </div>

        <div id="group-1">
            <div class="group-header flex justify-between items-center">
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">1. ON/OFF PERFORMANCE</h2>
                <span class="text-slate-400 font-bold text-sm">CHANNEL & PRODUCT ANALYSIS</span>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-slate-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">TOTAL Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>전체 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="total-list">
                                        <tr><td colspan="4" class="text-center text-slate-400 py-8">조회하기 버튼을 눌러 데이터를 불러오세요</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="total-t-color" class="badge bg-slate-100 text-slate-600">전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="total-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="total-t-size" class="badge bg-slate-100 text-slate-600">전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="total-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <span id="main-chart-title" class="text-sm font-black text-slate-600">TOTAL TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="main-sales" onclick="setChart('main', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="main-qty" onclick="setChart('main', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="main-daily" onclick="setChart('main', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="main-weekly" onclick="setChart('main', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="main-monthly" onclick="setChart('main', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 400px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>컬러별 판매 수량 차트</span><span id="total-chart-color" class="badge bg-slate-100 text-slate-600">전체</span></div>
                        <div style="height: 320px; flex: 1;"><canvas id="colorChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 400px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>사이즈별 판매 수량 차트</span><span id="total-chart-size" class="badge bg-slate-100 text-slate-600">전체</span></div>
                        <div style="height: 320px; flex: 1;"><canvas id="sizeChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-blue-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Online Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>온라인 채널별 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널명</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="on-list">
                                        <tr><td colspan="4" class="text-center text-slate-400 py-8">조회하기 버튼을 눌러 데이터를 불러오세요</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="on-t-color" class="badge bg-blue-100 text-blue-600">온라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="on-color-table"><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="on-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="on-t-size" class="badge bg-blue-100 text-blue-600">온라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="on-size-table"><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="on-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <span id="on-chart-title" class="text-sm font-black text-blue-600">ONLINE TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="on-sales" onclick="setChart('on', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="on-qty" onclick="setChart('on', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="on-daily" onclick="setChart('on', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="on-weekly" onclick="setChart('on', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="on-monthly" onclick="setChart('on', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="onChart"></canvas></div>
                </div>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-red-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Offline Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>오프라인 채널별 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널명</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="off-list">
                                        <tr><td colspan="4" class="text-center text-slate-400 py-8">조회하기 버튼을 눌러 데이터를 불러오세요</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="off-t-color" class="badge bg-red-100 text-red-600">오프라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="off-color-table"><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="off-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="off-t-size" class="badge bg-red-100 text-red-600">오프라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="off-size-table"><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="off-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <span id="off-chart-title" class="text-sm font-black text-red-600">OFFLINE TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="off-sales" onclick="setChart('off', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="off-qty" onclick="setChart('off', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="off-daily" onclick="setChart('off', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="off-weekly" onclick="setChart('off', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="off-monthly" onclick="setChart('off', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="offChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>오프라인 매장 실적 TOP 15</span><span id="off-t-shop" class="badge bg-slate-100 text-slate-600">오프라인 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table class="w-full text-left"><thead><tr><th>순위</th><th>매장명</th><th>매출액</th><th>수량</th></tr></thead><tbody id="shop-rank-body"></tbody></table></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>전국 지역별 매출 분포</span><span id="off-t-region" class="badge bg-slate-100 text-slate-600">오프라인 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table class="w-full text-left"><thead><tr><th>Region</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead><tbody id="region-rank-body"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="group-2" class="pb-20">
            <div class="group-header">
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">2. CUSTOMER ANALYSIS</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>회원 채널별 실적 (3-Depth)</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);">
                            <table>
                                <thead><tr><th>채널 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                <tbody id="cust-list">
                                    <tr><td colspan="4" class="text-center text-slate-400 py-8">조회하기 버튼을 눌러 데이터를 불러오세요</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>회원 비중</span></div>
                        <div style="height: 320px; flex: 1;"><canvas id="memberShareChart"></canvas></div>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="cust-t-color" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="cust-color-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="cust-t-size" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="cust-size-body"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8">
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>기존/신규 회원</span><span id="cust-t-member" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);">
                            <table>
                                <thead><tr><th>회원 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                <tbody id="cust-member-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="flex justify-between items-center mb-4">
                            <div class="section-title" style="margin: 0;">
                                <span>성별/연령대 분석</span>
                            </div>
                            <div class="control-group">
                                <button id="age-sales" onclick="setAgeChart('sales')" class="btn-toggle btn-active">매출액</button>
                                <button id="age-qty" onclick="setAgeChart('qty')" class="btn-toggle btn-inactive">판매량</button>
                            </div>
                        </div>
                        <div id="ageChartContainer" style="height: 350px; flex: 1; position: relative;"><canvas id="ageChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수: 로드된 데이터 저장
        let dashboardData = null;
        let DATA = null;
        
        // 데이터 로드 함수
        async function loadData() {
            try {
                const response = await fetch('data/sales_daily.json', { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result || !result.data) {
                    throw new Error('데이터 형식이 올바르지 않습니다.');
                }
                
                // 전역 변수에 데이터 할당
                dashboardData = result.data;
                
                console.log('데이터 로드 성공:', dashboardData.length, '건');

                // 콘솔에서 데이터 구조를 직접 확인하기 위한 코드
                if (dashboardData && dashboardData.length > 0) {
                    console.log("데이터 샘플:", dashboardData[0]);
                    console.log("데이터의 키 목록:", Object.keys(dashboardData[0]));
                    
                    const sampleBrand = dashboardData[0].BRD_CD || "BRD_CD 없음";
                    console.log("첫 번째 데이터의 브랜드 값:", sampleBrand);
                } else {
                    console.log("dashboardData가 비어있습니다.");
                }

                // 브랜드 드롭다운 옵션 채우기 (sales_daily.json의 BRD_CD에서 추출)
                await updateBrandDropdown();
                
                // 품번 드롭다운 채우기 ('전체' 브랜드 기준)
                updatePartCdDropdown('전체');
                
                // 날짜 필터 기본값 설정 (데이터의 가장 빠른/늦은 날짜)
                updateDateRangeDefaults();

                return dashboardData;
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                return null;
            }
        }
        
        function parseSaleDate(raw) {
            if (!raw) return null;
            if (raw instanceof Date) return raw;
            const s = String(raw);
            // YYYYMMDD
            if (/^\d{8}$/.test(s)) {
                const y = Number(s.slice(0, 4));
                const m = Number(s.slice(4, 6)) - 1;
                const d = Number(s.slice(6, 8));
                return new Date(y, m, d);
            }
            // YYYY-MM-DD or ISO
            const dt = new Date(s);
            return Number.isNaN(dt.getTime()) ? null : dt;
        }

        function formatDateLabel(d) {
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${mm}-${dd}`;
        }

        function getWeekKey(d) {
            // ISO week key: YYYY-Wxx
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function getMonthKey(d) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }

        function getSelectedBrand() {
            const el = document.getElementById('brand-filter');
            if (!el) return '전체';
            
            // Select2가 초기화되어 있으면 Select2의 값을 사용
            if (window.jQuery && jQuery(el).data('select2')) {
                const val = jQuery(el).val();
                return val || '전체';
            }
            
            // 일반 select인 경우
            return el.value || '전체';
        }

        function getSelectedPartCd() {
            const el = document.getElementById('part-filter');
            if (!el) return [];
            
            // Select2 multiple인 경우
            if (window.jQuery && jQuery(el).data('select2')) {
                const selected = jQuery(el).val();
                return Array.isArray(selected) ? selected : (selected ? [selected] : []);
            }
            
            // 일반 select multiple인 경우
            if (el.multiple) {
                return Array.from(el.selectedOptions).map(opt => opt.value);
            }
            
            // 단일 선택인 경우
            return el.value ? [el.value] : [];
        }

        function getSelectedDateRange() {
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            const start = startEl?.value ? parseSaleDate(startEl.value) : null;
            const end = endEl?.value ? parseSaleDate(endEl.value) : null;
            // end는 해당 날짜 포함을 위해 23:59:59로 보정
            if (end) end.setHours(23, 59, 59, 999);
            return { start, end };
        }

        async function updateBrandDropdown() {
            const select = document.getElementById('brand-filter');
            if (!select) {
                console.error('브랜드 드롭다운 요소를 찾을 수 없습니다.');
                return;
            }

            // 현재 선택된 브랜드 값 가져오기 (Select2 고려)
            let prev = '전체';
            if (window.jQuery && jQuery(select).data('select2')) {
                const currentVal = jQuery(select).val();
                prev = currentVal || '전체';
            } else {
                prev = select.value || '전체';
            }
            
            // 브랜드 목록을 수집할 Set (sales_daily.json 우선)
            const brandSet = new Set();
            
            // 1. data/sales_daily.json의 BRD_CD에서 브랜드 추출 (우선)
            if (dashboardData && Array.isArray(dashboardData) && dashboardData.length > 0) {
                console.log('dashboardData 확인:', dashboardData.length, '건');
                dashboardData.forEach((row, index) => {
                    if (row.BRD_CD && String(row.BRD_CD).trim() !== '') {
                        const brandCode = String(row.BRD_CD).trim();
                        brandSet.add(brandCode);
                        // 처음 5개만 로그 출력
                        if (index < 5) {
                            console.log(`  [${index}] BRD_CD:`, brandCode);
                        }
                    }
                });
                console.log('sales_daily.json에서 브랜드 추출 완료:', Array.from(brandSet).sort());
            } else {
                console.warn('dashboardData가 없거나 비어있습니다. dashboardData:', dashboardData);
            }
            
            // 2. data/brands.json 파일에서 브랜드 목록 가져오기 (보조, 없을 경우 대비)
            if (brandSet.size === 0) {
                console.log('brands.json에서 브랜드 로드 시도...');
                try {
                    const brandsResponse = await fetch('data/brands.json', { cache: 'no-store' });
                    if (brandsResponse.ok) {
                        const brandsData = await brandsResponse.json();
                        if (brandsData && brandsData.brands && Array.isArray(brandsData.brands)) {
                            brandsData.brands.forEach(brand => {
                                if (brand && String(brand).trim() !== '') {
                                    brandSet.add(String(brand).trim());
                                }
                            });
                            console.log('brands.json에서 브랜드 로드:', Array.from(brandSet).sort());
                        }
                    } else {
                        console.warn('brands.json 로드 실패: HTTP', brandsResponse.status);
                    }
                } catch (error) {
                    console.warn('brands.json 로드 실패:', error);
                }
            }
            
            // 브랜드 목록을 정렬
            const brands = Array.from(brandSet).sort();
            
            if (brands.length === 0) {
                console.error('브랜드가 하나도 추출되지 않았습니다!');
                return;
            }
            
            console.log('최종 브랜드 목록:', brands);
            
            // Select2가 이미 초기화되어 있으면 destroy
            if (window.jQuery && jQuery(select).data('select2')) {
                jQuery(select).select2('destroy');
            }
            
            // 드롭다운 옵션 완전히 교체 ('전체' 옵션 유지)
            select.innerHTML = '<option value="전체">전체</option>';
            
            // 브랜드 옵션 추가
            brands.forEach(brand => {
                const opt = document.createElement('option');
                opt.value = brand;
                opt.textContent = brand;
                select.appendChild(opt);
            });

            // selection 유지: 이전 선택값이 있으면 유지, 없으면 항상 '전체' 선택
            const exists = [...select.options].some(o => o.value === prev);
            let selectedValue = '전체'; // 기본값은 항상 '전체'
            
            if (exists && prev !== '전체') {
                // 이전 선택값이 있고 '전체'가 아니면 유지
                selectedValue = prev;
            }
            // 그 외의 경우는 항상 '전체' 선택
            
            console.log('브랜드 드롭다운 선택값 설정:', { prev, selectedValue, exists });
            
            // 실제 select의 value 설정
            select.value = selectedValue;

            // Select2 다시 초기화 (옵션이 모두 추가된 후)
            if (window.jQuery) {
                // 먼저 실제 select의 value를 설정
                select.value = selectedValue;
                
                // Select2 destroy 전에 현재 선택값 저장
                const wasSelect2 = jQuery(select).data('select2');
                let currentSelectedValue = selectedValue;
                if (wasSelect2) {
                    const currentVal = jQuery(select).val();
                    if (currentVal && currentVal !== '전체') {
                        // 사용자가 선택한 값이 있으면 그것을 우선 사용
                        currentSelectedValue = currentVal;
                        select.value = currentSelectedValue;
                    }
                }
                
                jQuery(select).select2({ 
                    placeholder: "브랜드 선택", 
                    allowClear: false,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "검색 결과가 없습니다.";
                        },
                        searching: function() {
                            return "검색 중...";
                        }
                    }
                });
                
                // Select2의 값 설정 (change 이벤트는 트리거하지 않음 - 무한 루프 방지)
                jQuery(select).val(currentSelectedValue);
                
                // Select2가 값을 제대로 반영하도록 강제 업데이트
                setTimeout(() => {
                    const currentVal = jQuery(select).val();
                    const finalValue = currentVal || currentSelectedValue;
                    
                    if (jQuery(select).val() !== finalValue) {
                        jQuery(select).val(finalValue);
                    }
                    
                    // 실제 select의 value도 동기화
                    if (select.value !== finalValue) {
                        select.value = finalValue;
                    }
                    
                    // Select2의 표시값 강제 업데이트
                    const select2Instance = jQuery(select).data('select2');
                    if (select2Instance) {
                        // 선택된 옵션의 텍스트 찾기
                        const selectedOption = select.querySelector(`option[value="${finalValue}"]`);
                        if (selectedOption) {
                            select2Instance.$container.find('.select2-selection__rendered').text(selectedOption.textContent);
                        }
                    }
                }, 100);
            }
            
            console.log('브랜드 드롭다운 업데이트 완료:', brands.length, '개 브랜드', brands);
            console.log('현재 선택된 브랜드:', selectedValue);
        }

        function updatePartCdDropdown(brand = null, resetSelection = true) {
            console.log('=== updatePartCdDropdown 호출 ===');
            console.log('전달된 brand:', brand);
            console.log('resetSelection:', resetSelection);
            console.log('dashboardData 존재 여부:', !!dashboardData);
            console.log('dashboardData 길이:', dashboardData ? dashboardData.length : 0);
            
            const select = document.getElementById('part-filter');
            if (!select) {
                console.error('part-filter 요소를 찾을 수 없습니다!');
                return;
            }
            console.log('part-filter 요소 찾음');

            // 브랜드가 변경되면 품번 선택을 초기화해야 함
            // resetSelection이 true이면 이전 선택값을 무시하고 초기화
            let prevSelected = [];
            const shouldResetSelection = resetSelection;
            
            if (!shouldResetSelection) {
                // 브랜드가 변경되지 않았을 때만 이전 선택값 유지
                if (window.jQuery && jQuery(select).data('select2')) {
                    // Select2 multiple인 경우
                    const selected = jQuery(select).val();
                    prevSelected = Array.isArray(selected) ? selected : (selected ? [selected] : []);
                } else if (select.multiple) {
                    // 일반 select multiple인 경우
                    prevSelected = Array.from(select.selectedOptions).map(opt => opt.value);
                } else {
                    // 단일 선택인 경우
                    prevSelected = select.value ? [select.value] : [];
                }
            }

            if (!dashboardData || !Array.isArray(dashboardData)) {
                console.warn('품번 드롭다운 업데이트 실패: dashboardData가 없습니다.');
                // Select2가 있으면 비우기
                if (window.jQuery && jQuery(select).data('select2')) {
                    select.innerHTML = '';
                    jQuery(select).val(null).trigger('change.select2');
                } else {
                    select.innerHTML = '';
                }
                return;
            }
            
            // 브랜드 필터 적용 (brand가 null이면 전체, '전체'면 전체)
            let filteredForPart = dashboardData;
            if (brand && brand !== '전체') {
                filteredForPart = dashboardData.filter(row => {
                    const rowBrand = String(row.BRD_CD || '').trim();
                    const brandValue = String(brand || '').trim();
                    const match = rowBrand === brandValue;
                    if (!match && filteredForPart.length < 5) {
                        console.log(`브랜드 불일치: row.BRD_CD="${rowBrand}" !== brand="${brandValue}"`);
                    }
                    return match;
                });
                console.log(`브랜드 필터링: "${brand}" → ${filteredForPart.length}건`);
            }
            
            // PART_CD 중복 제거하여 추출
            const partCodes = [...new Set(
                filteredForPart
                    .map(row => row.PART_CD)
                    .filter(v => v != null && String(v).trim() !== '')
                    .map(v => String(v))
            )].sort();

            // 디버깅: 품번 개수 확인
            console.log('추출된 품번 개수:', partCodes.length);
            console.log('품번 목록 (처음 10개):', partCodes.slice(0, 10));

            // Select2가 이미 초기화되어 있으면 destroy
            const wasSelect2 = window.jQuery && jQuery(select).data('select2');
            if (wasSelect2) {
                jQuery(select).select2('destroy');
            }

            // 옵션 초기화 및 추가
            select.innerHTML = '';
            
            // 품번 옵션 추가 (복수 선택 지원)
            partCodes.forEach(cd => {
                const opt = document.createElement('option');
                opt.value = cd;
                opt.textContent = cd;
                // 브랜드가 변경되지 않았을 때만 이전 선택값 유지
                if (!shouldResetSelection && prevSelected.includes(cd)) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            // Select2 다시 초기화 (multiple 모드)
            if (window.jQuery) {
                jQuery(select).select2({
                    placeholder: "품번 선택 (복수 선택 가능)",
                    allowClear: true,
                    multiple: true,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "검색 결과가 없습니다.";
                        },
                        searching: function() {
                            return "검색 중...";
                        }
                    }
                });
                
                // 브랜드가 변경된 경우 선택값 초기화, 그렇지 않으면 유효한 선택값만 유지
                if (shouldResetSelection) {
                    // 브랜드 변경 시 품번 선택 초기화
                    jQuery(select).val(null).trigger('change.select2');
                } else {
                    // 선택된 값들을 다시 설정 (유효한 값만)
                    const validSelected = partCodes.filter(cd => prevSelected.includes(cd));
                    if (validSelected.length > 0) {
                        jQuery(select).val(validSelected).trigger('change.select2');
                    } else {
                        jQuery(select).val(null).trigger('change.select2');
                    }
                }
            }
            
            console.log(`품번 드롭다운 업데이트 완료: ${partCodes.length}개 품번 (브랜드: ${brand || '전체'}, 선택된 품번: ${prevSelected.length}개)`);
        }

        // 이전 선택된 브랜드 추적 (품번 초기화를 위해)
        let previousBrand = null;
        
        // 브랜드 드롭다운 변경 이벤트 핸들러 (전역 함수)
        function handleBrandChange(event) {
            const brandSelect = document.getElementById('brand-filter');
            if (!brandSelect) return;
            
            // Select2의 값을 먼저 읽기
            let selectedBrand = '전체';
            if (window.jQuery && jQuery(brandSelect).data('select2')) {
                const select2Val = jQuery(brandSelect).val();
                selectedBrand = select2Val || '전체';
                // 실제 select의 value도 동기화
                if (brandSelect.value !== selectedBrand) {
                    brandSelect.value = selectedBrand;
                }
                
                // Select2의 표시값이 제대로 반영되도록 강제 업데이트
                setTimeout(() => {
                    const currentSelect2Val = jQuery(brandSelect).val();
                    if (currentSelect2Val !== selectedBrand) {
                        jQuery(brandSelect).val(selectedBrand);
                    }
                    
                    // Select2의 표시 텍스트 강제 업데이트
                    const select2Instance = jQuery(brandSelect).data('select2');
                    if (select2Instance && selectedBrand !== '전체') {
                        const selectedOption = brandSelect.querySelector(`option[value="${selectedBrand}"]`);
                        if (selectedOption) {
                            const renderedElement = select2Instance.$container.find('.select2-selection__rendered');
                            if (renderedElement.length) {
                                renderedElement.text(selectedOption.textContent);
                            }
                        }
                    }
                }, 100);
            } else {
                selectedBrand = brandSelect.value || '전체';
            }
            
            console.log('=== 브랜드 변경 이벤트 트리거 ===');
            console.log('선택된 브랜드:', selectedBrand);
            console.log('이전 브랜드:', previousBrand);
            console.log('Select2 값:', window.jQuery && jQuery(brandSelect).data('select2') ? jQuery(brandSelect).val() : 'N/A');
            console.log('실제 select value:', brandSelect.value);
            
            // 브랜드가 변경되었는지 확인
            const brandChanged = previousBrand !== selectedBrand;
            previousBrand = selectedBrand; // 현재 브랜드를 이전 브랜드로 저장
            
            // 데이터가 로드되어 있으면 해당 브랜드의 품번만 표시하도록 업데이트
            if (dashboardData && Array.isArray(dashboardData) && dashboardData.length > 0) {
                console.log('✅ dashboardData 존재, 품번 드롭다운 업데이트 시작');
                // 브랜드가 변경되었으면 품번 선택 초기화
                updatePartCdDropdown(selectedBrand, brandChanged);
            } else {
                console.warn('⚠️ dashboardData 없음! 조회하기 버튼을 먼저 눌러주세요.');
            }
        }

        function updateDateRangeDefaults() {
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            if (!startEl || !endEl || !dashboardData || !Array.isArray(dashboardData)) return;

            // 데이터에서 날짜 추출 및 파싱
            const dates = dashboardData
                .map(row => parseSaleDate(row.SALE_DT))
                .filter(d => d != null)
                .sort((a, b) => a - b);

            if (dates.length === 0) return;

            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            // 날짜가 설정되어 있지 않을 때만 기본값 설정
            if (!startEl.value) {
                startEl.value = minDate.toISOString().slice(0, 10);
            }
            if (!endEl.value) {
                endEl.value = maxDate.toISOString().slice(0, 10);
            }
        }

        function filterRows(brand, partCds) {
            if (!dashboardData || !Array.isArray(dashboardData)) return [];
            const { start, end } = getSelectedDateRange();
            
            // partCds가 배열인지 확인
            const partCdArray = Array.isArray(partCds) ? partCds : (partCds ? [partCds] : []);
            
            return dashboardData.filter(row => {
                const okBrand = !brand || brand === '전체' || row.BRD_CD === brand;
                
                // 품번 필터링: 배열이 비어있거나 '전체'가 포함되어 있으면 모든 품번 허용
                let okPart = true;
                if (partCdArray.length > 0 && !partCdArray.includes('전체')) {
                    okPart = partCdArray.includes(String(row.PART_CD));
                }
                
                const rowDate = parseSaleDate(row.SALE_DT);
                const okDate = (!start || (rowDate && rowDate >= start)) && (!end || (rowDate && rowDate <= end));
                return okBrand && okPart && okDate;
            });
        }

        // filteredData 기반으로 DATA 재계산 (성능 최적화: 한 번의 forEach로 모든 계산 수행)
        function buildDATA(filteredData) {
            if (!filteredData || !Array.isArray(filteredData)) return null;
            
            // 회원 판별: Snowflake와 동일 — CUST_ID IS NOT NULL AND TRIM(CAST(CUST_ID AS VARCHAR)) <> ''
            function isMemberRow(row) {
                const v = row.CUST_ID;
                if (v == null) return false;
                const s = String(v).trim();
                return s !== '';
            }
            
            // 회원 전용 집계 (채널별) — ANAL_DIST_TYPE_NM 기준: 온라인 / 백화점·직영점·대리점 = 오프라인
            let memberOnlineAmt = 0, memberOnlineQty = 0, memberOfflineAmt = 0, memberOfflineQty = 0;
            const memberColors = {}, memberSizes = {};
            const memberOnlineColors = {}, memberOnlineSizes = {}, memberOfflineColors = {}, memberOfflineSizes = {};
            
            // ANAL_DIST_TYPE_NM별 집계 초기화 (백화점, 직영점, 대리점, 온라인)
            const distTypeStats = {
                '백화점': { amt: 0, qty: 0, colors: {}, sizes: {} },
                '직영점': { amt: 0, qty: 0, colors: {}, sizes: {} },
                '대리점': { amt: 0, qty: 0, colors: {}, sizes: {} },
                '온라인': { amt: 0, qty: 0, colors: {}, sizes: {} }
            };
            
            // 온라인 채널별 집계 (SHOP_NM_SHORT 기준)
            const onlineChannelStats = {};
            
            // 오프라인 채널별 매장(SHOP_NM_SHORT) 집계 및 지역(REGION_NM) 집계
            const offlineShopStats = { '오프라인 전체': {}, '백화점': {}, '직영점': {}, '대리점': {} };
            const offlineGeoStats = { '오프라인 전체': {}, '백화점': {}, '직영점': {}, '대리점': {} };
            
            // COLOR_CD와 SIZE_CD별 집계 초기화 (전체용)
            const colorStats = {};
            const sizeStats = {};
            
            // 날짜별 그룹화 및 채널별 집계 초기화
            const dateGroups = {};
            
            // 디버그: 현재 필터에서 ANAL_DIST_TYPE_NM 값 분포 확인 (회원 온라인 0 원인 파악)
            const dTypeCounts = {};
            let memberOnlineRows = 0, memberOfflineRows = 0;
            filteredData.forEach(r => {
                const dt = String(r.ANAL_DIST_TYPE_NM || '').trim();
                dTypeCounts[dt] = (dTypeCounts[dt] || 0) + 1;
                const isM = (r.CUST_ID != null && String(r.CUST_ID).trim() !== '');
                if (isM) {
                    if (dt === '온라인') memberOnlineRows++;
                    else if (['백화점','직영점','대리점'].includes(dt)) memberOfflineRows++;
                }
            });
            console.log('[회원 채널 디버그] 필터된 행 수:', filteredData.length);
            console.log('[회원 채널 디버그] ANAL_DIST_TYPE_NM 분포:', dTypeCounts);
            console.log('[회원 채널 디버그] 회원 행 중 온라인 수:', memberOnlineRows, '/ 오프라인 수:', memberOfflineRows);
            if (filteredData.length > 0) {
                console.log('[회원 채널 디버그] 첫 행 샘플 ANAL_DIST_TYPE_NM:', JSON.stringify(filteredData[0].ANAL_DIST_TYPE_NM), '키 목록:', Object.keys(filteredData[0]));
            }
            
            // 한 번의 forEach로 모든 집계 수행 (Snowflake 쿼리 로직과 동일)
            filteredData.forEach(row => {
                // 1) 유통망 구분 변수 (루프 최상단) — ANAL_DIST_TYPE_NM만 사용
                const dType = String(row.ANAL_DIST_TYPE_NM || '').trim();
                const isOnline = (dType === '온라인');
                const isOffline = ['백화점', '직영점', '대리점'].includes(dType);
                
                const allAmt = Number(row.ALL_AMT) || 0;
                const allQty = Number(row.ALL_QTY) || 0;
                const cidAmt = Number(row.CID_AMT) || 0;
                const cidQty = Number(row.CID_QTY) || 0;
                const cidCnt = Number(row.CID_CNT) || 0;
                
                const date = row.SALE_DT;
                const shopNmShort = String(row.SHOP_NM_SHORT || '').trim();
                // 전국 지역별 매출 분포: REGION_NM만 사용 (없으면 '미분류'). ANAL_DIST_TYPE_NM 사용 금지.
                const region = (row.REGION_NM != null && String(row.REGION_NM).trim() !== '') ? String(row.REGION_NM).trim() : '미분류';
                const colorCd = String(row.COLOR_CD || '').trim();
                const sizeCd = String(row.SIZE_CD || '').trim();
                const isMember = isMemberRow(row);
                
                // 2. 전체 실적: 모든 행을 isOnline/isOffline에 따라 합산
                if (isOnline) {
                    distTypeStats['온라인'].amt += allAmt;
                    distTypeStats['온라인'].qty += allQty;
                    if (colorCd) distTypeStats['온라인'].colors[colorCd] = (distTypeStats['온라인'].colors[colorCd] || 0) + allQty;
                    if (sizeCd) distTypeStats['온라인'].sizes[sizeCd] = (distTypeStats['온라인'].sizes[sizeCd] || 0) + allQty;
                } else if (isOffline) {
                    distTypeStats[dType].amt += allAmt;
                    distTypeStats[dType].qty += allQty;
                    if (colorCd) distTypeStats[dType].colors[colorCd] = (distTypeStats[dType].colors[colorCd] || 0) + allQty;
                    if (sizeCd) distTypeStats[dType].sizes[sizeCd] = (distTypeStats[dType].sizes[sizeCd] || 0) + allQty;
                }
                
                // 3) 회원 집계 로직 (지시대로 그대로)
                if (isMember) {
                    if (isOnline) {
                        // 온라인 변수에만 더하기
                        memberOnlineAmt += allAmt;
                        memberOnlineQty += allQty;
                        if (colorCd) memberOnlineColors[colorCd] = (memberOnlineColors[colorCd] || 0) + allQty;
                        if (sizeCd) memberOnlineSizes[sizeCd] = (memberOnlineSizes[sizeCd] || 0) + allQty;
                    } else if (isOffline) {
                        // 오프라인 변수에만 더하기
                        memberOfflineAmt += allAmt;
                        memberOfflineQty += allQty;
                        if (colorCd) memberOfflineColors[colorCd] = (memberOfflineColors[colorCd] || 0) + allQty;
                        if (sizeCd) memberOfflineSizes[sizeCd] = (memberOfflineSizes[sizeCd] || 0) + allQty;
                    }
                    if (colorCd) memberColors[colorCd] = (memberColors[colorCd] || 0) + allQty;
                    if (sizeCd) memberSizes[sizeCd] = (memberSizes[sizeCd] || 0) + allQty;
                }
                
                // 1-1. 온라인 채널별 집계 (SHOP_NM_SHORT 기준) — ANAL_DIST_TYPE_NM = '온라인'만
                if (isOnline && shopNmShort) {
                    if (!onlineChannelStats[shopNmShort]) {
                        onlineChannelStats[shopNmShort] = {
                            amt: 0,
                            qty: 0,
                            colors: {},
                            sizes: {}
                        };
                    }
                    onlineChannelStats[shopNmShort].amt += allAmt;
                    onlineChannelStats[shopNmShort].qty += allQty;
                    if (colorCd) onlineChannelStats[shopNmShort].colors[colorCd] = (onlineChannelStats[shopNmShort].colors[colorCd] || 0) + allQty;
                    if (sizeCd) onlineChannelStats[shopNmShort].sizes[sizeCd] = (onlineChannelStats[shopNmShort].sizes[sizeCd] || 0) + allQty;
                }
                
                // 1-2. 오프라인 채널별 매장(SHOP_NM_SHORT) 및 지역(REGION_NM) 집계 — 키는 region(REGION_NM 또는 '미분류')만 사용
                if (isOffline) {
                    if (shopNmShort) {
                        ['오프라인 전체', dType].forEach(key => {
                            if (!offlineShopStats[key][shopNmShort]) offlineShopStats[key][shopNmShort] = { amt: 0, qty: 0 };
                            offlineShopStats[key][shopNmShort].amt += allAmt;
                            offlineShopStats[key][shopNmShort].qty += allQty;
                        });
                    }
                    ['오프라인 전체', dType].forEach(key => {
                        if (!offlineGeoStats[key][region]) offlineGeoStats[key][region] = { amt: 0, qty: 0 };
                        offlineGeoStats[key][region].amt += allAmt;
                        offlineGeoStats[key][region].qty += allQty;
                    });
                }
                
                // 2. COLOR_CD별 ALL_QTY 합계 (전체 컬러별 판매 현황 차트용)
                if (colorCd) {
                    colorStats[colorCd] = (colorStats[colorCd] || 0) + allQty;
                }
                
                // 3. SIZE_CD별 ALL_QTY 합계 (전체 사이즈별 판매 현황 차트용)
                if (sizeCd) {
                    sizeStats[sizeCd] = (sizeStats[sizeCd] || 0) + allQty;
                }
                
                // 4. 날짜별 채널별 집계 (트렌드 차트용) — ANAL_DIST_TYPE_NM 기준
                if (!dateGroups[date]) {
                    dateGroups[date] = { 
                        온라인: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 }, 
                        오프라인: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 },
                        백화점: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 },
                        직영점: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 },
                        대리점: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 }
                    };
                }
                
                // 온라인 채널별 날짜별 집계 (SHOP_NM_SHORT 기준)
                if (isOnline && shopNmShort) {
                    if (!dateGroups[date][shopNmShort]) {
                        dateGroups[date][shopNmShort] = { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 };
                    }
                    dateGroups[date][shopNmShort].amt += allAmt;
                    dateGroups[date][shopNmShort].qty += allQty;
                    dateGroups[date][shopNmShort].cidAmt += cidAmt;
                    dateGroups[date][shopNmShort].cidQty += cidQty;
                    dateGroups[date][shopNmShort].cidCnt += cidCnt;
                }
                
                // ANAL_DIST_TYPE_NM 기준으로 온라인/오프라인 집계
                if (isOnline) {
                    dateGroups[date].온라인.amt += allAmt;
                    dateGroups[date].온라인.qty += allQty;
                    dateGroups[date].온라인.cidAmt += cidAmt;
                    dateGroups[date].온라인.cidQty += cidQty;
                    dateGroups[date].온라인.cidCnt += cidCnt;
                } else if (isOffline) {
                    dateGroups[date].오프라인.amt += allAmt;
                    dateGroups[date].오프라인.qty += allQty;
                    dateGroups[date].오프라인.cidAmt += cidAmt;
                    dateGroups[date].오프라인.cidQty += cidQty;
                    dateGroups[date].오프라인.cidCnt += cidCnt;
                    
                    // 각 유통 유형별 집계
                    if (dType === '백화점') {
                        dateGroups[date].백화점.amt += allAmt;
                        dateGroups[date].백화점.qty += allQty;
                        dateGroups[date].백화점.cidAmt += cidAmt;
                        dateGroups[date].백화점.cidQty += cidQty;
                        dateGroups[date].백화점.cidCnt += cidCnt;
                    } else if (dType === '직영점') {
                        dateGroups[date].직영점.amt += allAmt;
                        dateGroups[date].직영점.qty += allQty;
                        dateGroups[date].직영점.cidAmt += cidAmt;
                        dateGroups[date].직영점.cidQty += cidQty;
                        dateGroups[date].직영점.cidCnt += cidCnt;
                    } else if (dType === '대리점') {
                        dateGroups[date].대리점.amt += allAmt;
                        dateGroups[date].대리점.qty += allQty;
                        dateGroups[date].대리점.cidAmt += cidAmt;
                        dateGroups[date].대리점.cidQty += cidQty;
                        dateGroups[date].대리점.cidCnt += cidCnt;
                    }
                }
            });
            
            // 회원 온라인/오프라인 분리 확인 (Snowflake 결과와 비교용)
            console.log('회원 온라인/오프라인 분리 체크:', memberOnlineAmt, memberOfflineAmt);
            
            // 온라인 채널별 합계 계산 (모든 온라인 채널의 합계)
            let totalOnlineChannelAmt = 0, totalOnlineChannelQty = 0;
            Object.values(onlineChannelStats).forEach(stats => {
                totalOnlineChannelAmt += stats.amt;
                totalOnlineChannelQty += stats.qty;
            });
            
            // 전체 집계 계산
            let totalOnlineAmt = 0, totalOnlineQty = 0, totalOfflineAmt = 0, totalOfflineQty = 0;
            let totalCidAmt = 0, totalCidQty = 0, totalCidCnt = 0;
            
            Object.values(dateGroups).forEach(group => {
                totalOnlineAmt += group.온라인.amt;
                totalOnlineQty += group.온라인.qty;
                totalOfflineAmt += group.오프라인.amt;
                totalOfflineQty += group.오프라인.qty;
                totalCidAmt += group.온라인.cidAmt + group.오프라인.cidAmt;
                totalCidQty += group.온라인.cidQty + group.오프라인.cidQty;
                totalCidCnt += group.온라인.cidCnt + group.오프라인.cidCnt;
            });
            
            // 온라인 전체는 모든 온라인 채널(SHOP_NM_SHORT 기준)의 합계로 설정
            // 온라인 채널이 있으면 채널 합계 사용, 없으면 기존 온라인 합계 사용
            const finalOnlineAmt = totalOnlineChannelAmt > 0 ? totalOnlineChannelAmt : totalOnlineAmt;
            const finalOnlineQty = totalOnlineChannelQty > 0 ? totalOnlineChannelQty : totalOnlineQty;
            
            // 오프라인 합계 = 백화점 + 직영점 + 대리점 (ANAL_DIST_TYPE_NM 기준)
            const offlineAmtFromDistType = distTypeStats['백화점'].amt + distTypeStats['직영점'].amt + distTypeStats['대리점'].amt;
            const offlineQtyFromDistType = distTypeStats['백화점'].qty + distTypeStats['직영점'].qty + distTypeStats['대리점'].qty;
            
            // 전체 합계 = 오프라인(백화점+직영점+대리점) + 온라인(ANAL_DIST_TYPE_NM 기준)
            const totalAmt = offlineAmtFromDistType + distTypeStats['온라인'].amt;
            const totalQty = offlineQtyFromDistType + distTypeStats['온라인'].qty;
            
            // 회원/비회원 합계 (회원 비중 차트·회원 채널별 실적용)
            const memberTotalAmt = memberOnlineAmt + memberOfflineAmt;
            const memberTotalQty = memberOnlineQty + memberOfflineQty;
            const nonMemberAmt = Math.max(0, totalAmt - memberTotalAmt);
            const nonMemberQty = Math.max(0, totalQty - memberTotalQty);
            
            // 오프라인 합계의 컬러/사이즈 통계 (백화점 + 직영점 + 대리점)
            const offlineColors = {};
            const offlineSizes = {};
            ['백화점', '직영점', '대리점'].forEach(type => {
                Object.entries(distTypeStats[type].colors).forEach(([color, qty]) => {
                    offlineColors[color] = (offlineColors[color] || 0) + qty;
                });
                Object.entries(distTypeStats[type].sizes).forEach(([size, qty]) => {
                    offlineSizes[size] = (offlineSizes[size] || 0) + qty;
                });
            });
            
            // 온라인 전체의 컬러/사이즈 통계 (모든 온라인 채널의 합계)
            const onlineColors = {};
            const onlineSizes = {};
            Object.values(onlineChannelStats).forEach(stats => {
                Object.entries(stats.colors || {}).forEach(([color, qty]) => {
                    onlineColors[color] = (onlineColors[color] || 0) + qty;
                });
                Object.entries(stats.sizes || {}).forEach(([size, qty]) => {
                    onlineSizes[size] = (onlineSizes[size] || 0) + qty;
                });
            });
            
            // 온라인 채널이 없으면 distTypeStats['온라인']의 colors/sizes 사용
            if (Object.keys(onlineColors).length === 0 && distTypeStats['온라인']) {
                Object.entries(distTypeStats['온라인'].colors || {}).forEach(([color, qty]) => {
                    onlineColors[color] = (onlineColors[color] || 0) + qty;
                });
                Object.entries(distTypeStats['온라인'].sizes || {}).forEach(([size, qty]) => {
                    onlineSizes[size] = (onlineSizes[size] || 0) + qty;
                });
            }
            
            // DATA 구조 생성
            DATA = {
                total: {
                    '전체': { qty: totalQty, sales: totalAmt, colors: colorStats, sizes: sizeStats },
                    '온라인': { qty: distTypeStats['온라인'].qty, sales: distTypeStats['온라인'].amt, colors: distTypeStats['온라인'].colors, sizes: distTypeStats['온라인'].sizes },
                    '오프라인': { qty: offlineQtyFromDistType, sales: offlineAmtFromDistType, colors: offlineColors, sizes: offlineSizes },
                    '백화점': { qty: distTypeStats['백화점'].qty, sales: distTypeStats['백화점'].amt, colors: distTypeStats['백화점'].colors, sizes: distTypeStats['백화점'].sizes },
                    '직영점': { qty: distTypeStats['직영점'].qty, sales: distTypeStats['직영점'].amt, colors: distTypeStats['직영점'].colors, sizes: distTypeStats['직영점'].sizes },
                    '대리점': { qty: distTypeStats['대리점'].qty, sales: distTypeStats['대리점'].amt, colors: distTypeStats['대리점'].colors, sizes: distTypeStats['대리점'].sizes }
                },
                on: {
                    // 온라인 전체는 모든 온라인 채널의 합계
                    '온라인 전체': { qty: finalOnlineQty, sales: finalOnlineAmt, colors: onlineColors, sizes: onlineSizes },
                    // 온라인 채널별 데이터 추가 (SHOP_NM_SHORT 기준)
                    ...Object.fromEntries(
                        Object.entries(onlineChannelStats).map(([channelName, stats]) => [
                            channelName,
                            { qty: stats.qty, sales: stats.amt, colors: stats.colors, sizes: stats.sizes }
                        ])
                    )
                },
                off: {
                    '오프라인 전체': { qty: offlineQtyFromDistType, sales: offlineAmtFromDistType, colors: offlineColors, sizes: offlineSizes, shops: offlineShopStats['오프라인 전체'], geo: offlineGeoStats['오프라인 전체'] },
                    '백화점': { qty: distTypeStats['백화점'].qty, sales: distTypeStats['백화점'].amt, colors: distTypeStats['백화점'].colors, sizes: distTypeStats['백화점'].sizes, shops: offlineShopStats['백화점'], geo: offlineGeoStats['백화점'] },
                    '직영점': { qty: distTypeStats['직영점'].qty, sales: distTypeStats['직영점'].amt, colors: distTypeStats['직영점'].colors, sizes: distTypeStats['직영점'].sizes, shops: offlineShopStats['직영점'], geo: offlineGeoStats['직영점'] },
                    '대리점': { qty: distTypeStats['대리점'].qty, sales: distTypeStats['대리점'].amt, colors: distTypeStats['대리점'].colors, sizes: distTypeStats['대리점'].sizes, shops: offlineShopStats['대리점'], geo: offlineGeoStats['대리점'] }
                },
                // cust: DATA.cust['온라인'] = memberOnlineAmt만, DATA.cust['오프라인'] = memberOfflineAmt만 사용
                cust: {
                    '회원 전체': { 
                        qty: memberTotalQty, 
                        sales: memberTotalAmt, 
                        colors: memberColors, 
                        sizes: memberSizes,
                        members: {
                            기존회원: { qty: Math.floor(memberTotalQty * 0.7), sales: Math.floor(memberTotalAmt * 0.7) },
                            신규회원: { qty: Math.floor(memberTotalQty * 0.3), sales: Math.floor(memberTotalAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    },
                    '온라인': { 
                        qty: memberOnlineQty, 
                        sales: memberOnlineAmt, 
                        colors: memberOnlineColors, 
                        sizes: memberOnlineSizes,
                        members: {
                            기존회원: { qty: Math.floor(memberOnlineQty * 0.7), sales: Math.floor(memberOnlineAmt * 0.7) },
                            신규회원: { qty: Math.floor(memberOnlineQty * 0.3), sales: Math.floor(memberOnlineAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    },
                    '오프라인': { 
                        qty: memberOfflineQty, 
                        sales: memberOfflineAmt, 
                        colors: memberOfflineColors, 
                        sizes: memberOfflineSizes,
                        members: {
                            기존회원: { qty: Math.floor(memberOfflineQty * 0.7), sales: Math.floor(memberOfflineAmt * 0.7) },
                            신규회원: { qty: Math.floor(memberOfflineQty * 0.3), sales: Math.floor(memberOfflineAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    }
                },
                memberShare: { member: { amt: memberTotalAmt, qty: memberTotalQty }, nonMember: { amt: nonMemberAmt, qty: nonMemberQty } },
                trendData: dateGroups
            };
            
            // 강제 할당: 집계된 회원 온라인 값이 DATA.cust['온라인'](한글)에 확실히 반영되도록
            DATA.cust['온라인'] = {
                qty: memberOnlineQty,
                sales: memberOnlineAmt,
                colors: memberOnlineColors,
                sizes: memberOnlineSizes,
                members: {
                    기존회원: { qty: Math.floor(memberOnlineQty * 0.7), sales: Math.floor(memberOnlineAmt * 0.7) },
                    신규회원: { qty: Math.floor(memberOnlineQty * 0.3), sales: Math.floor(memberOnlineAmt * 0.3) }
                },
                ageGender: { male: {}, female: {} }
            };
            console.log('DATA.cust 온라인 체크:', DATA.cust['온라인']);
            
            // 검증: Snowflake 쿼리 결과와 비교용 콘솔 출력
            const totalOnlineSales = DATA.total['온라인'].sales;
            const memberOnlineSales = DATA.cust['온라인'].sales;
            const totalSales = DATA.total['전체'].sales;
            const memberSales = DATA.cust['회원 전체'].sales;
            
            console.log('=== Snowflake 쿼리 결과 비교 ===');
            console.log('전체 온라인 매출:', totalOnlineSales);
            console.log('회원 온라인 매출:', memberOnlineSales);
            console.log('전체 매출:', totalSales);
            console.log('회원 전체 매출:', memberSales);
            console.log('회원 온라인 비중:', totalOnlineSales > 0 ? ((memberOnlineSales / totalOnlineSales) * 100).toFixed(1) + '%' : 'N/A');
            console.log('==============================');
            
            return DATA;
        }

        function renderSummaryTables() {
            if (!DATA) return;

            const formatAmt = (v) => Number(v || 0).toLocaleString();
            const formatQty = (v) => Number(v || 0).toLocaleString();
            const ratio = (v, total) => (total > 0 ? ((v / total) * 100).toFixed(1) : '0.0');

            // TOTAL
            const totalBody = document.getElementById('total-list');
            if (totalBody) {
                const tAll = DATA.total['전체'];
                const tOn = DATA.total['온라인'];
                const tOff = DATA.total['오프라인'];
                totalBody.innerHTML = `
                    <tr id="total-total-row" class="clickable-row selected-total" onclick="updateTotalDetail('전체', this)">
                        <td class="font-bold">전체</td><td>${formatAmt(tAll.sales)}</td><td>${formatQty(tAll.qty)}</td><td>100%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateTotalDetail('온라인', this)">
                        <td class="pl-5 font-semibold text-blue-600">온라인</td><td>${formatAmt(tOn.sales)}</td><td>${formatQty(tOn.qty)}</td><td>${ratio(tOn.sales, tAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateTotalDetail('오프라인', this)">
                        <td class="pl-5 font-semibold text-red-600">오프라인</td><td>${formatAmt(tOff.sales)}</td><td>${formatQty(tOff.qty)}</td><td>${ratio(tOff.sales, tAll.sales)}%</td>
                    </tr>
                `;
            }

            // ON
            const onBody = document.getElementById('on-list');
            if (onBody) {
                const onAll = DATA.on['온라인 전체'] || { sales: 0, qty: 0 };
                
                // 온라인 채널 목록 추출 (온라인 전체 제외, SHOP_NM_SHORT 값들)
                const onlineChannels = Object.keys(DATA.on)
                    .filter(key => key !== '온라인 전체')
                    .sort();
                
                let rowsHtml = `
                    <tr id="on-total-row" class="clickable-row selected-online" onclick="updateIndicator('on', '온라인 전체', this)">
                        <td>온라인 전체</td><td>${formatAmt(onAll.sales)}</td><td>${formatQty(onAll.qty)}</td><td>100%</td>
                    </tr>
                `;
                
                // 각 온라인 채널을 하위 행으로 추가 (SHOP_NM_SHORT 값 사용)
                onlineChannels.forEach(channelName => {
                    const channelData = DATA.on[channelName] || { sales: 0, qty: 0 };
                    const channelSales = channelData.sales || 0;
                    const channelQty = channelData.qty || 0;
                    const salesRatio = onAll.sales > 0 ? ratio(channelSales, onAll.sales) : '0.0';
                    
                    rowsHtml += `
                        <tr class="clickable-row" onclick="updateIndicator('on', '${channelName}', this)">
                            <td class="pl-6 text-slate-500">└ ${channelName}</td><td>${formatAmt(channelSales)}</td><td>${formatQty(channelQty)}</td><td>${salesRatio}%</td>
                        </tr>
                    `;
                });
                
                onBody.innerHTML = rowsHtml;
            }

            // OFF
            const offBody = document.getElementById('off-list');
            if (offBody) {
                const offAll = DATA.off['오프라인 전체'] || { sales: 0, qty: 0 };
                const off백화점 = DATA.off['백화점'] || { sales: 0, qty: 0 };
                const off직영점 = DATA.off['직영점'] || { sales: 0, qty: 0 };
                const off대리점 = DATA.off['대리점'] || { sales: 0, qty: 0 };
                offBody.innerHTML = `
                    <tr id="off-total-row" class="clickable-row selected-offline" onclick="updateIndicator('off', '오프라인 전체', this)">
                        <td>오프라인 전체</td><td>${formatAmt(offAll.sales)}</td><td>${formatQty(offAll.qty)}</td><td>100%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateIndicator('off', '백화점', this)">
                        <td class="pl-6 text-slate-500">└ 백화점</td><td>${formatAmt(off백화점.sales)}</td><td>${formatQty(off백화점.qty)}</td><td>${ratio(off백화점.sales, offAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateIndicator('off', '직영점', this)">
                        <td class="pl-6 text-slate-500">└ 직영점</td><td>${formatAmt(off직영점.sales)}</td><td>${formatQty(off직영점.qty)}</td><td>${ratio(off직영점.sales, offAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateIndicator('off', '대리점', this)">
                        <td class="pl-6 text-slate-500">└ 대리점</td><td>${formatAmt(off대리점.sales)}</td><td>${formatQty(off대리점.qty)}</td><td>${ratio(off대리점.sales, offAll.sales)}%</td>
                    </tr>
                `;
            }

            // CUSTOMER — 회원 채널별 실적: DATA.cust 한글 키만 사용 ('회원 전체', '온라인', '오프라인')
            const custBody = document.getElementById('cust-list');
            if (custBody) {
                const cAll = DATA.cust['회원 전체'];
                const cOn = DATA.cust['온라인'];
                const cOff = DATA.cust['오프라인'];
                custBody.innerHTML = `
                    <tr id="cust-total-row" class="clickable-row selected-customer" onclick="updateCustomerDetail('회원 전체', this)">
                        <td class="font-bold">회원 전체</td><td>${formatAmt(cAll.sales)}</td><td>${formatQty(cAll.qty)}</td><td>100%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateCustomerDetail('온라인', this)">
                        <td class="pl-5 font-semibold text-blue-600">온라인</td><td>${formatAmt(cOn.sales)}</td><td>${formatQty(cOn.qty)}</td><td>${ratio(cOn.sales, cAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateCustomerDetail('오프라인', this)">
                        <td class="pl-5 font-semibold text-red-600">오프라인</td><td>${formatAmt(cOff.sales)}</td><td>${formatQty(cOff.qty)}</td><td>${ratio(cOff.sales, cAll.sales)}%</td>
                    </tr>
                `;
            }
        }

        async function updateDashboard() {
            // 선택된 필터 값 가져오기
            const selectedBrand = getSelectedBrand();
            const selectedPartCds = getSelectedPartCd(); // 배열로 반환됨
            const { start, end } = getSelectedDateRange();
            
            // 콘솔에 선택값 출력
            console.log('=== 필터 선택값 ===');
            console.log('브랜드:', selectedBrand);
            console.log('품번 (복수 선택):', selectedPartCds);
            console.log('시작일:', start ? start.toISOString().slice(0, 10) : '없음');
            console.log('종료일:', end ? end.toISOString().slice(0, 10) : '없음');
            console.log('==================');
            
            // 데이터가 없으면 로드 (페이지 로드 시 이미 로드되어 있어야 하지만 안전장치)
            if (!dashboardData) {
                await loadData();
            }
            if (!dashboardData) {
                console.warn('dashboardData가 없어 대시보드를 그릴 수 없습니다. data/sales_daily.json 생성/배치가 필요합니다.');
                alert('데이터를 불러올 수 없습니다. data/sales_daily.json 파일을 확인해주세요.');
                return;
            }

            // 필터링된 데이터 생성 (품번은 배열로 전달)
            const filteredData = filterRows(selectedBrand, selectedPartCds);
            console.log(`필터링된 데이터: ${filteredData.length}건 (선택된 품번: ${selectedPartCds.length}개)`);

            // DATA 객체 생성 및 화면 업데이트
            buildDATA(filteredData);
            renderSummaryTables();

            // 기본 선택 상태/배지 갱신
            states.main.selectedChannel = '전체';
            states.on.selectedChannel = '온라인 전체';
            states.off.selectedChannel = '오프라인 전체';
            states.age.selectedChannel = '회원 전체';

            if (DATA) {
                fetchAll();
                const custRow = document.getElementById('cust-total-row');
                const totalRow = document.getElementById('total-total-row');
                if (custRow) updateCustomerDetail('회원 전체', custRow);
                if (totalRow) {
                    updateTotalDetail('전체', totalRow);
                    // 초기 컬러/사이즈 차트 렌더링
                    const totalData = DATA.total['전체'];
                    if (totalData) {
                        renderColorChart(totalData.colors);
                        renderSizeChart(totalData.sizes);
                    }
                }
            }
        }

        const states = {
            main: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '전체' },
            on: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '온라인 전체' },
            off: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '오프라인 전체' },
            age: { metric: 'sales', chart: null, selectedChannel: '회원 전체' }
        };

        // API URL
        const API_URL = "https://stylecode-api-dpqrqczbz89gpmn2hnxx34.streamlit.app/";

        // 브랜드 목록만 로드 (초기화용, sales_daily.json 로드 없이)
        async function loadBrandListOnly() {
            try {
                const res = await fetch('./data/brands.json', { cache: 'no-store' });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const { brands } = await res.json();
                console.log('브랜드 목록 로드 성공:', brands);
                
                if (brands && Array.isArray(brands) && brands.length > 0) {
                    const select = document.getElementById('brand-filter');
                    if (!select) return;
                    
                    // Select2가 이미 초기화되어 있으면 destroy
                    if (window.jQuery && jQuery(select).data('select2')) {
                        jQuery(select).select2('destroy');
                    }
                    
                    // 드롭다운 옵션 완전히 교체 ('전체' 옵션 유지)
                    select.innerHTML = '<option value="전체">전체</option>';
                    
                    // 브랜드 옵션 추가
                    brands.forEach(brand => {
                        const opt = document.createElement('option');
                        opt.value = brand;
                        opt.textContent = brand;
                        select.appendChild(opt);
                    });
                    
                    select.value = '전체';
                    
                    // Select2 다시 초기화
                    if (window.jQuery) {
                        jQuery(select).select2({ 
                            placeholder: "브랜드 선택", 
                            allowClear: false,
                            width: '100%',
                            language: {
                                noResults: function() {
                                    return "검색 결과가 없습니다.";
                                },
                                searching: function() {
                                    return "검색 중...";
                                }
                            }
                        });
                        jQuery(select).val('전체').trigger('change.select2');
                    }
                    
                    console.log('브랜드 드롭다운 초기화 완료:', brands.length, '개 브랜드');
                }
            } catch (error) {
                console.error('브랜드 목록 로드 실패:', error);
            }
        }

        // 매출액 API 호출
        async function loadSales() {
            const brandEl = document.getElementById('brand');
            const startDateEl = document.getElementById('startDate');

            // 현재 UI에서는 브랜드/기간을 사용하지 않음
            if (!brandEl || !startDateEl) {
                return;
            }

            // 브랜드가 선택되지 않았으면 호출하지 않음
            const brand = brandEl.value;
            if (!brand || brand.trim() === '') {
                return;
            }
            
            try {
                const startDate = startDateEl.value;
                
                // 월 계산 (startDate가 있으면 사용, 없으면 현재 월)
                let month = '2025-12';
                if (startDate) {
                    const date = new Date(startDate);
                    month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                const url = `${API_URL}?brand=${encodeURIComponent(brand)}&month=${encodeURIComponent(month)}`;
                console.log('매출액 API 호출:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Streamlit은 HTML로 감싸서 반환하므로 텍스트로 받아서 JSON 추출
                const text = await response.text();
                console.log('응답 텍스트 (일부):', text.substring(0, 500));
                
                let data;
                try {
                    // JSON 부분만 추출 - 여러 패턴 시도
                    let jsonMatch = text.match(/\{[\s\S]*"sales_amt"[\s\S]*"generated_at"[\s\S]*?\}/);
                    if (!jsonMatch) {
                        jsonMatch = text.match(/\{[\s\S]*"sales_amt"[\s\S]*?\}/);
                    }
                    if (!jsonMatch) {
                        jsonMatch = text.match(/\{[\s\S]*?\}/);
                    }
                    
                    if (jsonMatch) {
                        data = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('JSON을 찾을 수 없음');
                    }
                } catch (parseError) {
                    console.error('JSON 파싱 실패:', parseError);
                    console.error('원본 텍스트 (일부):', text.substring(0, 1000));
                    throw new Error('JSON 파싱 실패: ' + parseError.message);
                }
                
                console.log('파싱된 데이터:', data);
                
                // KPI 카드 업데이트 (요소가 존재하는 경우에만)
                const salesAmtElement = document.getElementById('kpi-sales-amt');
                const errorElement = document.getElementById('kpi-error');
                
                if (data && data.sales_amt !== undefined) {
                    if (salesAmtElement) {
                        // 숫자 포맷팅 (천 단위 구분)
                        const formattedAmount = new Intl.NumberFormat('ko-KR').format(data.sales_amt);
                        salesAmtElement.textContent = formattedAmount + '원';
                    }
                    if (errorElement) {
                        errorElement.style.display = 'none';
                    }
                } else {
                    throw new Error('sales_amt 필드가 없음');
                }
                
            } catch (error) {
                // 콘솔에만 상세 에러 로그 출력
                console.error('매출액 로드 실패:', error);
                console.error('에러 상세:', error.message, error.stack);
                
                // 화면에는 간단한 메시지만 표시 (요소가 존재하는 경우에만)
                const salesAmtElement = document.getElementById('kpi-sales-amt');
                const errorElement = document.getElementById('kpi-error');
                
                if (salesAmtElement) {
                    salesAmtElement.textContent = '-';
                }
                if (errorElement) {
                    errorElement.style.display = 'block';
                }
            }
        }

        // DOMContentLoaded 이후에 실행
        document.addEventListener('DOMContentLoaded', async function() {
            // 날짜 기본값 설정: 시작일 = 오늘-30일, 종료일 = 오늘
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            if (startEl && endEl) {
                const today = new Date();
                const startDate = new Date();
                startDate.setDate(today.getDate() - 30);
                
                startEl.value = startDate.toISOString().slice(0, 10);
                endEl.value = today.toISOString().slice(0, 10);
            }

            // 품번 드롭다운에만 select2 적용 (브랜드는 updateBrandDropdown에서 초기화)
            if (window.jQuery) {
                $('.js-part-filter').select2({ 
                    placeholder: "품번 선택 (복수 선택 가능)", 
                    allowClear: true,
                    multiple: true,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "검색 결과가 없습니다.";
                        },
                        searching: function() {
                            return "검색 중...";
                        }
                    }
                });
            }


            // PART_CD 변경 시 (조회하기 버튼을 눌러야 실제 반영)
            const partSelect = document.getElementById('part-filter');
            if (partSelect) {
                partSelect.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }

            // 날짜 변경 시 (조회하기 버튼을 눌러야 실제 반영)
            if (startEl) {
                startEl.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }
            if (endEl) {
                endEl.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }

            // 브랜드 목록과 데이터 미리 로드 (브랜드/품번 선택용)
            try {
                await loadData();
                
                // 브랜드 드롭다운 업데이트
                await updateBrandDropdown();
                
                // 초기 브랜드 값 설정 (전체)
                previousBrand = '전체';
                
                // 브랜드 변경 이벤트 연결 (데이터 로드 후)
                const brandSelect = document.getElementById('brand-filter');
                if (brandSelect) {
                    // 기존 이벤트 모두 제거
                    if (window.jQuery) {
                        jQuery(brandSelect).off('change.select2 change select2:select');
                    }
                    brandSelect.removeEventListener('change', handleBrandChange);
                    
                    // Select2 change 이벤트 (select2:select 이벤트도 추가)
                    if (window.jQuery) {
                        jQuery(brandSelect).on('change.select2', function(e) {
                            console.log('Select2 change 이벤트 발생, 값:', jQuery(this).val());
                            handleBrandChange(e);
                        });
                        jQuery(brandSelect).on('select2:select', function(e) {
                            console.log('Select2 select 이벤트 발생, 값:', jQuery(this).val());
                            // Select2의 값을 실제 select에도 반영
                            const selectedVal = jQuery(this).val();
                            if (selectedVal && brandSelect.value !== selectedVal) {
                                brandSelect.value = selectedVal;
                            }
                            handleBrandChange(e);
                        });
                    }
                    
                    // 일반 change 이벤트도 추가
                    brandSelect.addEventListener('change', handleBrandChange);
                }
                
                // 품번 드롭다운 초기화 (전체 브랜드 기준, 선택값 초기화)
                updatePartCdDropdown('전체', true);
                
                // 날짜 기본값 설정
                updateDateRangeDefaults();
                
                console.log('초기 데이터 로드 완료 - 브랜드/품번 선택 가능');
            } catch (error) {
                console.error('초기 데이터 로드 실패:', error);
            }
        });

        function setChart(key, type, val) {
            states[key][type] = val;
            $(`[id^="${key}-${type === 'metric' ? 'sales' : 'daily'}"]`).parent().find('button').removeClass('btn-active').addClass('btn-inactive');
            $(`#${key}-${val}`).addClass('btn-active').removeClass('btn-inactive');
            renderSingleChart(key);
        }

        function updateIndicator(type, name, rowElement) {
            const container = document.getElementById(`${type}-list`);
            Array.from(container.querySelectorAll('tr')).forEach(r => r.classList.remove(type === 'on' ? 'selected-online' : 'selected-offline'));
            if(rowElement) rowElement.classList.add(type === 'on' ? 'selected-online' : 'selected-offline');

            document.getElementById(`${type}-t-color`).innerText = name;
            document.getElementById(`${type}-t-size`).innerText = name;
            
            const d = DATA[type][name] || DATA[type][type === 'on' ? '온라인 전체' : '오프라인 전체'];
            fillTable(`${type}-color-body`, d.colors, d.qty);
            fillTable(`${type}-size-body`, d.sizes, d.qty);
            
            states[type].selectedChannel = name;
            document.getElementById(`${type}-chart-title`).innerText = `${type.toUpperCase()} TREND: ${name}`;
            renderSingleChart(type);

            if(type === 'off') {
                document.getElementById('off-t-region').innerText = name;
                document.getElementById('off-t-shop').innerText = name;
                updateShopRank(name);
                updateRegionTable(d.geo, d.qty);
            }
        }

        function updateTotalDetail(name, rowElement) {
            $('#total-list tr').removeClass('selected-total');
            $(rowElement).addClass('selected-total');
            $('#total-t-color').text(name);
            $('#total-t-size').text(name);
            $('#total-chart-color').text(name);
            $('#total-chart-size').text(name);
            
            const d = DATA.total[name] || DATA.total['전체'];
            fillTable('total-color-body', d.colors, d.qty);
            fillTable('total-size-body', d.sizes, d.qty);
            
            // 통합 매출 그래프 업데이트
            states.main.selectedChannel = name;
            document.getElementById('main-chart-title').innerText = `TOTAL TREND: ${name}`;
            renderSingleChart('main');
            
            // 컬러/사이즈 차트 업데이트
            renderColorChart(d.colors);
            renderSizeChart(d.sizes);
        }

        function updateCustomerDetail(name, rowElement) {
            $('#cust-list tr').removeClass('selected-customer');
            $(rowElement).addClass('selected-customer');
            $('#cust-t-color').text(name);
            $('#cust-t-size').text(name);
            
            // 회원 구분 배지 업데이트 (제목은 "기존/신규 회원"으로 고정)
            let displayName = name;
            if (!name.includes('전체') && name !== '자사몰') {
                displayName = name + ' 전체';
            }
            $('#cust-t-member').text(displayName);
            
            const d = DATA.cust[name]; // name: '회원 전체' | '온라인' | '오프라인' (한글 키)
            fillTable('cust-color-body', d.colors, d.qty);
            fillTable('cust-size-body', d.sizes, d.qty);
            fillMemberTable('cust-member-body', d.members, d.qty, d.sales, name);
            
            // 연령대 그래프 업데이트
            states.age.selectedChannel = name;
            renderAgeChart();
        }

        // 회원 전용 테이블: 반드시 DATA.cust[채널명]에서만 전달 (d.members, d.qty, d.sales). DATA.total 사용 금지.
        function fillMemberTable(id, members, totalQty, totalSales, channelName) {
            const b = document.getElementById(id);
            b.innerHTML = '';
            const safeQty = Number(totalQty) || 0;
            const safeSales = Number(totalSales) || 0;
            
            // SUM 행 추가 (선택한 채널명 표시)
            b.innerHTML += `<tr class="font-black bg-purple-50">
                <td>${channelName}</td>
                <td>${safeSales.toLocaleString()}</td>
                <td>${safeQty.toLocaleString()}</td>
                <td class="text-purple-600">100.0%</td>
            </tr>`;
            
            // 기존회원, 신규회원 행 추가
            const divQty = safeQty || 1;
            Object.entries(members).forEach(([memberType, data]) => {
                const qtyRatio = ((Number(data.qty) || 0) / divQty * 100).toFixed(1);
                b.innerHTML += `<tr>
                    <td class="font-bold">${memberType}</td>
                    <td>${(Number(data.sales) || 0).toLocaleString()}</td>
                    <td>${(Number(data.qty) || 0).toLocaleString()}</td>
                    <td class="text-slate-400">${qtyRatio}%</td>
                </tr>`;
            });
        }

        function fillTable(id, obj, total) {
            const b = document.getElementById(id); b.innerHTML = '';
            const safeTotal = Number(total) || 1;
            Object.entries(obj || {}).forEach(([k, v]) => {
                const val = Number(v) || 0;
                b.innerHTML += `<tr><td>${k}</td><td class="font-bold">${val.toLocaleString()}</td><td class="text-slate-400">${((val / safeTotal) * 100).toFixed(1)}%</td></tr>`;
            });
        }

        function updateShopRank(channel) {
            const body = document.getElementById('shop-rank-body');
            if (!body) return;
            body.innerHTML = '';
            const d = (DATA && DATA.off) ? (DATA.off[channel] || DATA.off['오프라인 전체']) : null;
            const shops = (d && d.shops) ? d.shops : {};
            const arr = Object.entries(shops).map(([name, v]) => ({ name, amt: Number(v.amt) || 0, qty: Number(v.qty) || 0 }));
            arr.sort((a, b) => b.amt - a.amt);
            const top15 = arr.slice(0, 15);
            if (top15.length === 0) {
                body.innerHTML = `<tr><td colspan="4" class="text-slate-400 font-bold text-center py-6">매장 랭킹 데이터가 없습니다.</td></tr>`;
                return;
            }
            top15.forEach((row, i) => {
                body.innerHTML += `<tr><td class="font-bold">${i + 1}</td><td>${row.name}</td><td>${(row.amt || 0).toLocaleString()}원</td><td>${(row.qty || 0).toLocaleString()}</td></tr>`;
            });
        }

        function updateRegionTable(geoData, totalQty) {
            const body = document.getElementById('region-rank-body');
            if (!body) return;
            body.innerHTML = '';
            if (!geoData || typeof geoData !== 'object') return;
            const total = Number(totalQty) || 1;
            Object.entries(geoData).forEach(([region, v]) => {
                const amt = (v && typeof v === 'object' && v.amt != null) ? Number(v.amt) : 0;
                const qty = (v && typeof v === 'object' && v.qty != null) ? Number(v.qty) : (Number(v) || 0);
                const pct = total > 0 ? ((qty / total) * 100).toFixed(1) : '0.0';
                body.innerHTML += `<tr><td class="font-bold">${region}</td><td>${amt.toLocaleString()}원</td><td>${qty.toLocaleString()}</td><td class="text-blue-600 font-black">${pct}%</td></tr>`;
            });
        }

        function renderSingleChart(key) {
            const canvasEl = document.getElementById(`${key}Chart`);
            if(!canvasEl) return;
            const s = states[key];
            if (s.chart) s.chart.destroy();

            // trendData 기반 시계열 생성
            const trend = (DATA && DATA.trendData) ? DATA.trendData : {};
            const entries = Object.entries(trend)
                .map(([rawDate, v]) => ({ rawDate, date: parseSaleDate(rawDate) || parseSaleDate(v?.date) }))
                .filter(x => x.date != null)
                .sort((a, b) => a.date - b.date);

            const metricKey = s.metric === 'sales' ? 'amt' : 'qty';

            function pickChannelVal(group, channelType) {
                if (!group || !group[channelType]) return 0;
                return Number(group[channelType][metricKey] || 0);
            }

            function buildSeries(channelType) {
                if (s.view === 'daily') {
                    const sliced = entries.slice(-14);
                    const labels = sliced.map(e => formatDateLabel(e.date));
                    const data = sliced.map(e => pickChannelVal(trend[e.rawDate], channelType));
                    return { labels, data };
                }
                if (s.view === 'weekly') {
                    const bucket = new Map();
                    entries.forEach(e => {
                        const key = getWeekKey(e.date);
                        bucket.set(key, (bucket.get(key) || 0) + pickChannelVal(trend[e.rawDate], channelType));
                    });
                    const keys = [...bucket.keys()].sort();
                    return { labels: keys.slice(-12), data: keys.slice(-12).map(k => bucket.get(k) || 0) };
                }
                // monthly
                const bucket = new Map();
                entries.forEach(e => {
                    const key = getMonthKey(e.date);
                    bucket.set(key, (bucket.get(key) || 0) + pickChannelVal(trend[e.rawDate], channelType));
                });
                const keys = [...bucket.keys()].sort();
                return { labels: keys.slice(-12), data: keys.slice(-12).map(k => bucket.get(k) || 0) };
            }

            let labels = [];
            let ds = [];

            if (key === 'main') {
                const channel = s.selectedChannel || '전체';
                if (channel === '전체') {
                    const onSeries = buildSeries('온라인');
                    const offSeries = buildSeries('오프라인');
                    labels = onSeries.labels.length ? onSeries.labels : offSeries.labels;
                    ds = [
                        { label: 'ONLINE TOTAL', data: onSeries.data, borderColor: '#2563eb', tension: 0.4, borderWidth: 2, pointRadius: 2 },
                        { label: 'OFFLINE TOTAL', data: offSeries.data, borderColor: '#dc2626', tension: 0.4, borderWidth: 2, pointRadius: 2 }
                    ];
                } else if (channel === '온라인') {
                    const onSeries = buildSeries('온라인');
                    labels = onSeries.labels;
                    ds = [{ label: 'ONLINE TOTAL', data: onSeries.data, borderColor: '#2563eb', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                } else if (channel === '오프라인') {
                    const offSeries = buildSeries('오프라인');
                    labels = offSeries.labels;
                    ds = [{ label: 'OFFLINE TOTAL', data: offSeries.data, borderColor: '#dc2626', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                }
            } else if (key === 'on') {
                const channel = s.selectedChannel || '온라인 전체';
                if (channel === '온라인 전체') {
                    // 온라인 전체 선택 시: 모든 온라인 채널 표시
                    const onSeries = buildSeries('온라인');
                    labels = onSeries.labels;
                    
                    // 온라인 채널 목록 가져오기
                    const onlineChannels = Object.keys(DATA.on || {}).filter(key => key !== '온라인 전체').sort();
                    
                    // 각 채널별 시리즈 생성
                    const channelSeries = onlineChannels.map(channelName => buildSeries(channelName));
                    
                    // 온라인 채널별 색상 배열 (오프라인과 구분되게: 청록색, 노란색, 분홍색, 갈색, 인디고 등)
                    // 오프라인: 주황(#f97316), 보라(#a855f7), 초록(#10b981) 사용 중
                    const onlineChannelColors = [
                        { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },      // 청록색 (cyan)
                        { border: '#eab308', bg: 'rgba(234, 179, 8, 0.1)' },       // 노란색 (yellow)
                        { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },     // 분홍색 (pink)
                        { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },    // 보라색 계열 (violet, 오프라인 보라와 다름)
                        { border: '#14b8a6', bg: 'rgba(20, 184, 166, 0.1)' },    // 틸 색상 (teal)
                        { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },    // 호박색 (amber)
                        { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },     // 빨간색 (red)
                        { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }     // 인디고 (indigo)
                    ];
                    
                    ds = [];
                    onlineChannels.forEach((channelName, index) => {
                        const series = channelSeries[index];
                        const colorSet = onlineChannelColors[index % onlineChannelColors.length];
                        ds.push({
                            label: channelName,
                            data: series.data,
                            borderColor: colorSet.border,
                            backgroundColor: colorSet.bg,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 2
                        });
                    });
                } else {
                    // 특정 채널 선택 시: 해당 채널만 표시
                    const channelSeries = buildSeries(channel);
                    labels = channelSeries.labels;
                    const channelIndex = Object.keys(DATA.on || {}).filter(key => key !== '온라인 전체').indexOf(channel);
                    
                    // 온라인 채널별 색상 배열 (오프라인과 구분되게)
                    const onlineChannelColors = [
                        { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },      // 청록색
                        { border: '#eab308', bg: 'rgba(234, 179, 8, 0.1)' },       // 노란색
                        { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },     // 분홍색
                        { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },    // 보라색 계열
                        { border: '#14b8a6', bg: 'rgba(20, 184, 166, 0.1)' },    // 틸 색상
                        { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },    // 호박색
                        { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },     // 빨간색
                        { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }     // 인디고
                    ];
                    
                    const colorSet = onlineChannelColors[channelIndex % onlineChannelColors.length] || { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' };
                    ds = [{
                        label: channel,
                        data: channelSeries.data,
                        borderColor: colorSet.border,
                        backgroundColor: colorSet.bg,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 2
                    }];
                }
            } else if (key === 'off') {
                const channel = s.selectedChannel || '오프라인 전체';
                if (channel === '오프라인 전체') {
                    // 오프라인 전체 선택 시: 백화점, 직영점, 대리점 3개만 표시 (전체 라인 제거)
                    // 색상: 주황색, 보라색, 초록색 계열로 구분 (빨강/파랑과 겹치지 않게)
                    const 백화점Series = buildSeries('백화점');
                    const 직영점Series = buildSeries('직영점');
                    const 대리점Series = buildSeries('대리점');
                    labels = 백화점Series.labels.length ? 백화점Series.labels : (직영점Series.labels.length ? 직영점Series.labels : 대리점Series.labels);
                    ds = [
                        { label: '백화점', data: 백화점Series.data, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }, // 주황색
                        { label: '직영점', data: 직영점Series.data, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }, // 보라색
                        { label: '대리점', data: 대리점Series.data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 } // 초록색
                    ];
                } else if (channel === '백화점') {
                    const 백화점Series = buildSeries('백화점');
                    labels = 백화점Series.labels;
                    ds = [{ label: '백화점', data: 백화점Series.data, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                } else if (channel === '직영점') {
                    const 직영점Series = buildSeries('직영점');
                    labels = 직영점Series.labels;
                    ds = [{ label: '직영점', data: 직영점Series.data, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                } else if (channel === '대리점') {
                    const 대리점Series = buildSeries('대리점');
                    labels = 대리점Series.labels;
                    ds = [{ label: '대리점', data: 대리점Series.data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                } else {
                    const offSeries = buildSeries('오프라인');
                    labels = offSeries.labels;
                    ds = [{ label: 'OFFLINE', data: offSeries.data, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                }
            }

            s.chart = new Chart(canvasEl.getContext('2d'), {
                type: 'line',
                data: { labels, datasets: ds },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function setAgeChart(metric) {
            states.age.metric = metric;
            $('#age-sales, #age-qty').removeClass('btn-active').addClass('btn-inactive');
            $(`#age-${metric}`).addClass('btn-active').removeClass('btn-inactive');
            renderAgeChart();
        }

        function renderMemberShareChart() {
            const canvasEl = document.getElementById('memberShareChart');
            if (!canvasEl || !DATA || !DATA.memberShare) return;
            if (window.memberShareChartInstance) window.memberShareChartInstance.destroy();
            const m = DATA.memberShare.member || { amt: 0, qty: 0 };
            const n = DATA.memberShare.nonMember || { amt: 0, qty: 0 };
            const totalAmt = m.amt + n.amt;
            if (totalAmt <= 0) {
                window.memberShareChartInstance = new Chart(canvasEl.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: ['회원 매출', '비회원 매출'], datasets: [{ data: [0, 0], backgroundColor: ['#8b5cf6', '#cbd5e1'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
                return;
            }
            const memberPct = ((m.amt / totalAmt) * 100).toFixed(1);
            const nonMemberPct = ((n.amt / totalAmt) * 100).toFixed(1);
            window.memberShareChartInstance = new Chart(canvasEl.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['회원 매출 (' + memberPct + '%)', '비회원 매출 (' + nonMemberPct + '%)'],
                    datasets: [{
                        data: [m.amt, n.amt],
                        backgroundColor: ['#8b5cf6', '#cbd5e1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const v = ctx.parsed;
                                    const pct = totalAmt > 0 ? ((v / totalAmt) * 100).toFixed(1) : '0';
                                    return ctx.label + ': ' + Number(v).toLocaleString() + '원 (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAgeChart() {
            const canvasEl = document.getElementById('ageChart');
            const container = document.getElementById('ageChartContainer');
            if(!canvasEl) return;
            const s = states.age;
            if (s.chart) s.chart.destroy();
            s.chart = null;

            const ageLabels = ['15-19', '20-24', '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59', '60~'];
            const channelName = s.selectedChannel || '회원 전체';
            const d = (DATA && DATA.cust) ? DATA.cust[channelName] : null;
            const hasAgeGender = d && d.ageGender && (
                Object.keys(d.ageGender.male || {}).length > 0 || Object.keys(d.ageGender.female || {}).length > 0
            );

            if (!d || !d.ageGender || !hasAgeGender) {
                if (container) {
                    let placeholder = container.querySelector('.age-chart-placeholder');
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.className = 'age-chart-placeholder flex items-center justify-center h-full text-slate-400 font-bold text-sm text-center px-4';
                        placeholder.textContent = '데이터 준비 중 (회원 정보 조인 필요)';
                        container.insertBefore(placeholder, canvasEl);
                    }
                    canvasEl.style.display = 'none';
                }
                return;
            }

            if (container) {
                const placeholder = container.querySelector('.age-chart-placeholder');
                if (placeholder) placeholder.remove();
                canvasEl.style.display = '';
            }

            const maleData = ageLabels.map(age => {
                const data = d.ageGender.male[age] || {qty: 0, sales: 0};
                return s.metric === 'sales' ? data.sales : data.qty;
            });

            const femaleData = ageLabels.map(age => {
                const data = d.ageGender.female[age] || {qty: 0, sales: 0};
                return s.metric === 'sales' ? data.sales : data.qty;
            });

            s.chart = new Chart(canvasEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ageLabels,
                    datasets: [
                        {
                            label: '남성',
                            data: maleData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 2
                        },
                        {
                            label: '여성',
                            data: femaleData,
                            backgroundColor: 'rgba(236, 72, 153, 0.7)',
                            borderColor: '#ec4899',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return context.dataset.label + ': ' + (s.metric === 'sales' ? value.toLocaleString() + '원' : value.toLocaleString());
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return s.metric === 'sales' ? (value / 1000000).toFixed(0) + 'M' : value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderColorChart(colorData) {
            const canvasEl = document.getElementById('colorChart');
            if (!canvasEl || !colorData) return;
            
            if (window.colorChartInstance) {
                window.colorChartInstance.destroy();
            }
            
            const sortedColors = Object.entries(colorData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // 상위 10개만 표시
            
            const labels = sortedColors.map(([color]) => color || '미지정');
            const data = sortedColors.map(([, qty]) => qty);
            
            window.colorChartInstance = new Chart(canvasEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '판매 수량',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: '#3b82f6',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '판매 수량: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderSizeChart(sizeData) {
            const canvasEl = document.getElementById('sizeChart');
            if (!canvasEl || !sizeData) return;
            
            if (window.sizeChartInstance) {
                window.sizeChartInstance.destroy();
            }
            
            const sortedSizes = Object.entries(sizeData)
                .sort((a, b) => {
                    // 사이즈를 숫자로 변환하여 정렬 (예: S=1, M=2, L=3 등)
                    const sizeOrder = { 'XS': 1, 'S': 2, 'M': 3, 'L': 4, 'XL': 5, 'XXL': 6 };
                    const aOrder = sizeOrder[a[0].toUpperCase()] || parseInt(a[0]) || 999;
                    const bOrder = sizeOrder[b[0].toUpperCase()] || parseInt(b[0]) || 999;
                    return aOrder - bOrder;
                });
            
            const labels = sortedSizes.map(([size]) => size || '미지정');
            const data = sortedSizes.map(([, qty]) => qty);
            
            window.sizeChartInstance = new Chart(canvasEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '판매 수량',
                        data: data,
                        backgroundColor: 'rgba(236, 72, 153, 0.7)',
                        borderColor: '#ec4899',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '판매 수량: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function fetchAll() { 
            renderSingleChart('main'); renderSingleChart('on'); renderSingleChart('off'); 
            updateIndicator('on', states.on.selectedChannel, null);
            updateIndicator('off', states.off.selectedChannel, null);
            renderMemberShareChart();
            renderAgeChart();
            document.getElementById('main-chart-title').innerText = `TOTAL TREND: ${states.main.selectedChannel || '전체'}`;
            
            // 컬러/사이즈 차트 초기 렌더링
            const totalData = DATA.total[states.main.selectedChannel || '전체'] || DATA.total['전체'];
            if (totalData) {
                renderColorChart(totalData.colors);
                renderSizeChart(totalData.sizes);
            }
        }
    </script>
</body>
</html>