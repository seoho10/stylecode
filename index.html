<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleCode Analytics Enterprise Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; font-size: 13px; color: #1e293b; }
        
        .table-container { height: 320px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: #f8fafc; z-index: 20; border-bottom: 1px solid #e2e8f0; padding: 12px 10px; font-size: 0.75rem; color: #64748b; font-weight: 700; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        
        .section-title { font-size: 0.95rem; font-weight: 800; margin-bottom: 0.75rem; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        
        .selected-online { background-color: #eff6ff !important; font-weight: 700; color: #1d4ed8; border-left: 4px solid #3b82f6; }
        .selected-offline { background-color: #fef2f2 !important; font-weight: 700; color: #b91c1c; border-left: 4px solid #ef4444; }
        .selected-customer { background-color: #f5f3ff !important; font-weight: 700; color: #7c3aed; border-left: 4px solid #8b5cf6; }
        .selected-total { background-color: #f1f5f9 !important; font-weight: 700; color: #0f172a; border-left: 4px solid #475569; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background-color: #f8fafc; }
        
        .btn-toggle { padding: 5px 12px; font-size: 0.7rem; font-weight: 700; border-radius: 6px; transition: all 0.2s; }
        .btn-active { background-color: white; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn-inactive { color: #94a3b8; border: 1px solid transparent; }
        .control-group { background-color: #e2e8f0; padding: 3px; border-radius: 8px; display: flex; gap: 2px; }
        
        .group-header { border-bottom: 4px solid #0f172a; padding-bottom: 0.75rem; margin: 3rem 0 1.5rem 0; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 9999px; font-weight: 800; }

        .select2-container { width: 100% !important; }
        .select2-selection--multiple { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; padding: 2px 6px !important; background-color: #f8fafc !important; }
        .select2-selection--single { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; background-color: #f8fafc !important; min-height: 42px !important; display: flex !important; align-items: center !important; }
        .select2-selection__rendered { font-weight: 800 !important; color: #0f172a !important; padding-left: 12px !important; }
        .select2-selection__arrow { height: 40px !important; }
        .select2-dropdown { border: 1px solid #e2e8f0 !important; border-radius: 8px !important; }
        .select2-results__option { padding: 8px 12px !important; font-weight: 600 !important; }
        .select2-results__option--highlighted { background-color: #0f172a !important; color: white !important; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-[1600px] mx-auto">
        
        <header class="mb-8">
            <div>
                <h1 class="text-4xl font-black tracking-tight text-slate-900 mb-2">
                    StyleCode Data Lab 
                    <span class="text-blue-600 bg-blue-50 px-3 py-1 rounded-lg inline-block ml-2">v2.9</span>
                </h1>
                <p class="text-slate-600 font-semibold text-lg">스타일 판매 성과 분석 통합 대시보드</p>
            </div>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Brand</label>
                    <select id="brand-filter" class="js-brand-filter">
                        <option value="전체">전체</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">품번 (PART_CD)</label>
                    <select id="part-filter" class="js-part-filter" multiple="multiple">
                    </select>
                </div>
                <div class="md:col-span-5" id="date-range">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Analysis Period</label>
                    <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2">
                        <input type="date" id="startDate" class="bg-transparent font-bold text-xs outline-none cursor-pointer flex-1">
                        <span class="text-slate-300 font-bold">~</span>
                        <input type="date" id="endDate" class="bg-transparent font-bold text-xs outline-none cursor-pointer flex-1">
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="updateDashboard()" class="bg-slate-900 text-white px-10 py-3 rounded-xl font-bold hover:bg-slate-800 transition transform active:scale-95 shadow-xl">조회하기</button>
            </div>
        </div>

        <div id="group-1">
            <div class="group-header flex justify-between items-center">
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">1. ON/OFF PERFORMANCE</h2>
                <span class="text-slate-400 font-bold text-sm">CHANNEL & PRODUCT ANALYSIS</span>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-slate-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">TOTAL Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>전체 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="total-list">
                                        <tr id="total-total-row" class="clickable-row selected-total" onclick="updateTotalDetail('전체', this)">
                                            <td class="font-bold">전체</td><td>772,100,000</td><td>6,300</td><td>100%</td>
                                        </tr>
                                        <tr class="clickable-row" onclick="updateTotalDetail('온라인', this)">
                                            <td class="pl-5 font-semibold text-blue-600">온라인</td><td>452,100,000</td><td>3,500</td><td>58.5%</td>
                                        </tr>
                                        <tr class="clickable-row" onclick="updateTotalDetail('오프라인', this)">
                                            <td class="pl-5 font-semibold text-red-600">오프라인</td><td>320,000,000</td><td>2,800</td><td>41.5%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="total-t-color" class="badge bg-slate-100 text-slate-600">전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="total-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="total-t-size" class="badge bg-slate-100 text-slate-600">전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="total-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <span id="main-chart-title" class="text-sm font-black text-slate-600">TOTAL TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="main-sales" onclick="setChart('main', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="main-qty" onclick="setChart('main', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="main-daily" onclick="setChart('main', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="main-weekly" onclick="setChart('main', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="main-monthly" onclick="setChart('main', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="mainChart"></canvas></div>
                </div>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-blue-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Online Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>온라인 채널별 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널명</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="on-list">
                                        <tr id="on-total-row" class="clickable-row selected-online" onclick="updateIndicator('on', '온라인 전체', this)"><td>온라인 전체</td><td>452,100,000</td><td>3,500</td><td>100%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('on', '자사몰', this)"><td class="pl-6 text-slate-500">└ 자사몰</td><td>135,630,000</td><td>1,050</td><td>30%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('on', '무신사', this)"><td class="pl-6 text-slate-500">└ 무신사</td><td>113,025,000</td><td>875</td><td>25%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('on', '네이버 스토어', this)"><td class="pl-6 text-slate-500">└ 네이버 스토어</td><td>90,420,000</td><td>700</td><td>20%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('on', '29CM', this)"><td class="pl-6 text-slate-500">└ 29CM</td><td>67,815,000</td><td>525</td><td>15%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('on', 'W컨셉', this)"><td class="pl-6 text-slate-500">└ W컨셉</td><td>45,210,000</td><td>350</td><td>10%</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="on-t-color" class="badge bg-blue-100 text-blue-600">온라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="on-color-table"><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="on-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="on-t-size" class="badge bg-blue-100 text-blue-600">온라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="on-size-table"><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="on-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <span id="on-chart-title" class="text-sm font-black text-blue-600">ONLINE TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="on-sales" onclick="setChart('on', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="on-qty" onclick="setChart('on', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="on-daily" onclick="setChart('on', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="on-weekly" onclick="setChart('on', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="on-monthly" onclick="setChart('on', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="onChart"></canvas></div>
                </div>
            </div>

            <div class="mb-16">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-red-600 rounded-full"></div>
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Offline Performance Detailed</h3>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>오프라인 채널별 실적</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);">
                                <table>
                                    <thead><tr><th>채널명</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                    <tbody id="off-list">
                                        <tr id="off-total-row" class="clickable-row selected-offline" onclick="updateIndicator('off', '오프라인 전체', this)"><td>오프라인 전체</td><td>320,000,000</td><td>2,800</td><td>100%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('off', '백화점', this)"><td class="pl-6 text-slate-500">└ 백화점</td><td>224,000,000</td><td>1,960</td><td>70%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('off', '대리점', this)"><td class="pl-6 text-slate-500">└ 대리점</td><td>64,000,000</td><td>560</td><td>20%</td></tr>
                                        <tr class="clickable-row" onclick="updateIndicator('off', '직영점', this)"><td class="pl-6 text-slate-500">└ 직영점</td><td>32,000,000</td><td>280</td><td>10%</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="off-t-color" class="badge bg-red-100 text-red-600">오프라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="off-color-table"><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="off-color-body"></tbody></table></div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                            <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="off-t-size" class="badge bg-red-100 text-red-600">오프라인 전체</span></div>
                            <div class="table-container flex-1" style="height: calc(100% - 60px);"><table id="off-size-table"><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="off-size-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <span id="off-chart-title" class="text-sm font-black text-red-600">OFFLINE TREND ANALYSIS</span>
                        <div class="flex gap-2">
                            <div class="control-group">
                                <button id="off-sales" onclick="setChart('off', 'metric', 'sales')" class="btn-toggle btn-active">매출</button>
                                <button id="off-qty" onclick="setChart('off', 'metric', 'qty')" class="btn-toggle btn-inactive">수량</button>
                            </div>
                            <div class="control-group">
                                <button id="off-daily" onclick="setChart('off', 'view', 'daily')" class="btn-toggle btn-active">일</button>
                                <button id="off-weekly" onclick="setChart('off', 'view', 'weekly')" class="btn-toggle btn-inactive">주</button>
                                <button id="off-monthly" onclick="setChart('off', 'view', 'monthly')" class="btn-toggle btn-inactive">월</button>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;"><canvas id="offChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>오프라인 매장 실적 TOP 15</span><span id="off-t-shop" class="badge bg-slate-100 text-slate-600">오프라인 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table class="w-full text-left"><thead><tr><th>순위</th><th>매장명</th><th>매출액</th><th>수량</th></tr></thead><tbody id="shop-rank-body"></tbody></table></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>전국 지역별 매출 분포</span><span id="off-t-region" class="badge bg-slate-100 text-slate-600">오프라인 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table class="w-full text-left"><thead><tr><th>Region</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead><tbody id="region-rank-body"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="group-2" class="pb-20">
            <div class="group-header">
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">2. CUSTOMER ANALYSIS</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl shadow-md border-2 border-slate-300" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>회원 채널별 실적 (3-Depth)</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);">
                            <table>
                                <thead><tr><th>채널 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                <tbody id="cust-list">
                                    <tr id="cust-total-row" class="clickable-row selected-customer" onclick="updateCustomerDetail('회원 전체', this)">
                                        <td class="font-bold">회원 전체</td><td>772,100,000</td><td>6,300</td><td>100%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('온라인', this)">
                                        <td class="pl-5 font-semibold text-blue-600">└ 온라인</td><td>452,100,000</td><td>3,500</td><td>58.5%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('자사몰', this)">
                                        <td class="pl-10 text-slate-500">└ 자사몰</td><td>452,100,000</td><td>3,500</td><td>100%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('오프라인', this)">
                                        <td class="pl-5 font-semibold text-red-600">└ 오프라인</td><td>320,000,000</td><td>2,800</td><td>41.5%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('백화점', this)">
                                        <td class="pl-10 text-slate-500">└ 백화점</td><td>224,000,000</td><td>1,960</td><td>70%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('대리점', this)">
                                        <td class="pl-10 text-slate-500">└ 대리점</td><td>64,000,000</td><td>560</td><td>20%</td>
                                    </tr>
                                    <tr class="clickable-row" onclick="updateCustomerDetail('직영점', this)">
                                        <td class="pl-10 text-slate-500">└ 직영점</td><td>32,000,000</td><td>280</td><td>10%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>컬러별 판매 현황</span><span id="cust-t-color" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>컬러</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="cust-color-body"></tbody></table></div>
                    </div>
                </div>
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>사이즈별 판매 현황</span><span id="cust-t-size" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);"><table><thead><tr><th>사이즈</th><th>판매수량</th><th>비중</th></tr></thead><tbody id="cust-size-body"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8">
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="section-title mb-4"><span>기존/신규 회원</span><span id="cust-t-member" class="badge bg-purple-100 text-purple-600">회원 전체</span></div>
                        <div class="table-container flex-1" style="height: calc(100% - 60px);">
                            <table>
                                <thead><tr><th>회원 구분</th><th>매출액</th><th>수량</th><th>비중</th></tr></thead>
                                <tbody id="cust-member-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height: 480px; display: flex; flex-direction: column;">
                        <div class="flex justify-between items-center mb-4">
                            <div class="section-title" style="margin: 0;">
                                <span>성별/연령대 분석</span>
                            </div>
                            <div class="control-group">
                                <button id="age-sales" onclick="setAgeChart('sales')" class="btn-toggle btn-active">매출액</button>
                                <button id="age-qty" onclick="setAgeChart('qty')" class="btn-toggle btn-inactive">판매량</button>
                            </div>
                        </div>
                        <div style="height: 350px; flex: 1;"><canvas id="ageChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수: 로드된 데이터 저장
        let dashboardData = null;
        let DATA = null;
        
        // 데이터 로드 함수
        async function loadData() {
            try {
                const response = await fetch('data/sales_daily.json', { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result || !result.data) {
                    throw new Error('데이터 형식이 올바르지 않습니다.');
                }
                
                // 전역 변수에 데이터 할당
                dashboardData = result.data;
                
                console.log('데이터 로드 성공:', dashboardData.length, '건');

                // 브랜드 드롭다운 옵션 채우기 (sales_daily.json의 BRD_CD에서 추출)
                await updateBrandDropdown();
                
                // 품번 드롭다운 채우기 ('전체' 브랜드 기준)
                updatePartCdDropdown('전체');
                
                // 날짜 필터 기본값 설정 (데이터의 가장 빠른/늦은 날짜)
                updateDateRangeDefaults();
                
                // 페이지 로드 시 자동으로 대시보드 업데이트
                await updateDashboard();

                return dashboardData;
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                return null;
            }
        }
        
        function parseSaleDate(raw) {
            if (!raw) return null;
            if (raw instanceof Date) return raw;
            const s = String(raw);
            // YYYYMMDD
            if (/^\d{8}$/.test(s)) {
                const y = Number(s.slice(0, 4));
                const m = Number(s.slice(4, 6)) - 1;
                const d = Number(s.slice(6, 8));
                return new Date(y, m, d);
            }
            // YYYY-MM-DD or ISO
            const dt = new Date(s);
            return Number.isNaN(dt.getTime()) ? null : dt;
        }

        function formatDateLabel(d) {
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${mm}-${dd}`;
        }

        function getWeekKey(d) {
            // ISO week key: YYYY-Wxx
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function getMonthKey(d) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }

        function getSelectedBrand() {
            const el = document.getElementById('brand-filter');
            return el ? el.value : '전체';
        }

        function getSelectedPartCd() {
            const el = document.getElementById('part-filter');
            if (!el) return [];
            
            // Select2 multiple인 경우
            if (window.jQuery && jQuery(el).data('select2')) {
                const selected = jQuery(el).val();
                return Array.isArray(selected) ? selected : (selected ? [selected] : []);
            }
            
            // 일반 select multiple인 경우
            if (el.multiple) {
                return Array.from(el.selectedOptions).map(opt => opt.value);
            }
            
            // 단일 선택인 경우
            return el.value ? [el.value] : [];
        }

        function getSelectedDateRange() {
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            const start = startEl?.value ? parseSaleDate(startEl.value) : null;
            const end = endEl?.value ? parseSaleDate(endEl.value) : null;
            // end는 해당 날짜 포함을 위해 23:59:59로 보정
            if (end) end.setHours(23, 59, 59, 999);
            return { start, end };
        }

        async function updateBrandDropdown() {
            const select = document.getElementById('brand-filter');
            if (!select) {
                console.error('브랜드 드롭다운 요소를 찾을 수 없습니다.');
                return;
            }

            const prev = select.value || '전체';
            
            // 브랜드 목록을 수집할 Set (sales_daily.json 우선)
            const brandSet = new Set();
            
            // 1. data/sales_daily.json의 BRD_CD에서 브랜드 추출 (우선)
            if (dashboardData && Array.isArray(dashboardData) && dashboardData.length > 0) {
                console.log('dashboardData 확인:', dashboardData.length, '건');
                dashboardData.forEach((row, index) => {
                    if (row.BRD_CD && String(row.BRD_CD).trim() !== '') {
                        const brandCode = String(row.BRD_CD).trim();
                        brandSet.add(brandCode);
                        // 처음 5개만 로그 출력
                        if (index < 5) {
                            console.log(`  [${index}] BRD_CD:`, brandCode);
                        }
                    }
                });
                console.log('sales_daily.json에서 브랜드 추출 완료:', Array.from(brandSet).sort());
            } else {
                console.warn('dashboardData가 없거나 비어있습니다. dashboardData:', dashboardData);
            }
            
            // 2. data/brands.json 파일에서 브랜드 목록 가져오기 (보조, 없을 경우 대비)
            if (brandSet.size === 0) {
                console.log('brands.json에서 브랜드 로드 시도...');
                try {
                    const brandsResponse = await fetch('data/brands.json', { cache: 'no-store' });
                    if (brandsResponse.ok) {
                        const brandsData = await brandsResponse.json();
                        if (brandsData && brandsData.brands && Array.isArray(brandsData.brands)) {
                            brandsData.brands.forEach(brand => {
                                if (brand && String(brand).trim() !== '') {
                                    brandSet.add(String(brand).trim());
                                }
                            });
                            console.log('brands.json에서 브랜드 로드:', Array.from(brandSet).sort());
                        }
                    } else {
                        console.warn('brands.json 로드 실패: HTTP', brandsResponse.status);
                    }
                } catch (error) {
                    console.warn('brands.json 로드 실패:', error);
                }
            }
            
            // 브랜드 목록을 정렬
            const brands = Array.from(brandSet).sort();
            
            if (brands.length === 0) {
                console.error('브랜드가 하나도 추출되지 않았습니다!');
                return;
            }
            
            console.log('최종 브랜드 목록:', brands);
            
            // Select2가 이미 초기화되어 있으면 destroy
            if (window.jQuery && jQuery(select).data('select2')) {
                jQuery(select).select2('destroy');
            }
            
            // 드롭다운 옵션 완전히 교체 ('전체' 옵션 유지)
            select.innerHTML = '<option value="전체">전체</option>';
            
            // 브랜드 옵션 추가
            brands.forEach(brand => {
                const opt = document.createElement('option');
                opt.value = brand;
                opt.textContent = brand;
                select.appendChild(opt);
            });

            // selection 유지: 이전 선택값이 있으면 유지, 없으면 항상 '전체' 선택
            const exists = [...select.options].some(o => o.value === prev);
            let selectedValue = '전체'; // 기본값은 항상 '전체'
            
            if (exists && prev !== '전체') {
                // 이전 선택값이 있고 '전체'가 아니면 유지
                selectedValue = prev;
            }
            // 그 외의 경우는 항상 '전체' 선택
            
            select.value = selectedValue;

            // Select2 다시 초기화 (옵션이 모두 추가된 후)
            if (window.jQuery) {
                jQuery(select).select2({ 
                    placeholder: "브랜드 선택", 
                    allowClear: false,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "검색 결과가 없습니다.";
                        },
                        searching: function() {
                            return "검색 중...";
                        }
                    }
                });
                // 선택값 설정
                jQuery(select).val(selectedValue).trigger('change.select2');
            }
            
            console.log('브랜드 드롭다운 업데이트 완료:', brands.length, '개 브랜드', brands);
            console.log('현재 선택된 브랜드:', selectedValue);
        }

        function updatePartCdDropdown(brand = null) {
            const select = document.getElementById('part-filter');
            if (!select) return;

            // 이전 선택값 저장 (복수 선택 지원)
            let prevSelected = [];
            if (window.jQuery && jQuery(select).data('select2')) {
                // Select2 multiple인 경우
                const selected = jQuery(select).val();
                prevSelected = Array.isArray(selected) ? selected : (selected ? [selected] : []);
            } else if (select.multiple) {
                // 일반 select multiple인 경우
                prevSelected = Array.from(select.selectedOptions).map(opt => opt.value);
            } else {
                // 단일 선택인 경우
                prevSelected = select.value ? [select.value] : [];
            }

            // 옵션 초기화
            select.innerHTML = '';

            if (!dashboardData || !Array.isArray(dashboardData)) {
                console.warn('품번 드롭다운 업데이트 실패: dashboardData가 없습니다.');
                return;
            }
            
            // 브랜드 필터 적용 (brand가 null이면 전체, '전체'면 전체)
            let filteredForPart = dashboardData;
            if (brand && brand !== '전체') {
                filteredForPart = dashboardData.filter(row => row.BRD_CD === brand);
                console.log(`브랜드 필터링: ${brand} → ${filteredForPart.length}건`);
            }
            
            // PART_CD 중복 제거하여 추출
            const partCodes = [...new Set(
                filteredForPart
                    .map(row => row.PART_CD)
                    .filter(v => v != null && String(v).trim() !== '')
                    .map(v => String(v))
            )].sort();

            // 품번 옵션 추가 (복수 선택 지원)
            partCodes.forEach(cd => {
                const opt = document.createElement('option');
                opt.value = cd;
                opt.textContent = cd;
                // 이전 선택값이 있고, 해당 브랜드에 속한 품번이면 선택 상태 유지
                if (prevSelected.includes(cd)) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            // select2 렌더 동기화 (multiple 모드 지원)
            if (window.jQuery && jQuery(select).data('select2')) {
                // 선택된 값들을 다시 설정 (해당 브랜드에 속한 품번만 유지)
                const validSelected = partCodes.filter(cd => prevSelected.includes(cd));
                if (validSelected.length > 0) {
                    jQuery(select).val(validSelected).trigger('change.select2');
                } else {
                    // 선택된 품번이 없거나 해당 브랜드에 속하지 않으면 초기화
                    jQuery(select).val(null).trigger('change.select2');
                }
            }
            
            console.log(`품번 드롭다운 업데이트 완료: ${partCodes.length}개 품번 (브랜드: ${brand || '전체'}, 선택된 품번: ${prevSelected.length}개)`);
        }

        function updateDateRangeDefaults() {
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            if (!startEl || !endEl || !dashboardData || !Array.isArray(dashboardData)) return;

            // 데이터에서 날짜 추출 및 파싱
            const dates = dashboardData
                .map(row => parseSaleDate(row.SALE_DT))
                .filter(d => d != null)
                .sort((a, b) => a - b);

            if (dates.length === 0) return;

            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            // 날짜가 설정되어 있지 않을 때만 기본값 설정
            if (!startEl.value) {
                startEl.value = minDate.toISOString().slice(0, 10);
            }
            if (!endEl.value) {
                endEl.value = maxDate.toISOString().slice(0, 10);
            }
        }

        function filterRows(brand, partCds) {
            if (!dashboardData || !Array.isArray(dashboardData)) return [];
            const { start, end } = getSelectedDateRange();
            
            // partCds가 배열인지 확인
            const partCdArray = Array.isArray(partCds) ? partCds : (partCds ? [partCds] : []);
            
            return dashboardData.filter(row => {
                const okBrand = !brand || brand === '전체' || row.BRD_CD === brand;
                
                // 품번 필터링: 배열이 비어있거나 '전체'가 포함되어 있으면 모든 품번 허용
                let okPart = true;
                if (partCdArray.length > 0 && !partCdArray.includes('전체')) {
                    okPart = partCdArray.includes(String(row.PART_CD));
                }
                
                const rowDate = parseSaleDate(row.SALE_DT);
                const okDate = (!start || (rowDate && rowDate >= start)) && (!end || (rowDate && rowDate <= end));
                return okBrand && okPart && okDate;
            });
        }

        // filteredData 기반으로 DATA 재계산
        function buildDATA(filteredData) {
            if (!filteredData || !Array.isArray(filteredData)) return null;
            
            // 날짜별로 그룹화하고 데이터 집계 (ANLYS_ON_OFF_CLS_NM 기준으로 온라인/오프라인 구분)
            const dateGroups = {};
            filteredData.forEach(item => {
                const date = item.SALE_DT;
                const channel = item.ANLYS_ON_OFF_CLS_NM || '전체';
                
                if (!dateGroups[date]) {
                    dateGroups[date] = { 
                        온라인: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 }, 
                        오프라인: { amt: 0, qty: 0, cidAmt: 0, cidQty: 0, cidCnt: 0 } 
                    };
                }
                
                // 채널별로 집계
                if (channel === '온라인' && dateGroups[date].온라인) {
                    dateGroups[date].온라인.amt += item.ALL_AMT || 0;
                    dateGroups[date].온라인.qty += item.ALL_QTY || 0;
                    dateGroups[date].온라인.cidAmt += item.CID_AMT || 0;
                    dateGroups[date].온라인.cidQty += item.CID_QTY || 0;
                    dateGroups[date].온라인.cidCnt += item.CID_CNT || 0;
                } else if (channel === '오프라인' && dateGroups[date].오프라인) {
                    dateGroups[date].오프라인.amt += item.ALL_AMT || 0;
                    dateGroups[date].오프라인.qty += item.ALL_QTY || 0;
                    dateGroups[date].오프라인.cidAmt += item.CID_AMT || 0;
                    dateGroups[date].오프라인.cidQty += item.CID_QTY || 0;
                    dateGroups[date].오프라인.cidCnt += item.CID_CNT || 0;
                }
            });
            
            // 전체 집계
            let totalOnlineAmt = 0, totalOnlineQty = 0, totalOfflineAmt = 0, totalOfflineQty = 0;
            let totalCidAmt = 0, totalCidQty = 0, totalCidCnt = 0;
            
            Object.values(dateGroups).forEach(group => {
                totalOnlineAmt += group.온라인.amt;
                totalOnlineQty += group.온라인.qty;
                totalOfflineAmt += group.오프라인.amt;
                totalOfflineQty += group.오프라인.qty;
                totalCidAmt += group.온라인.cidAmt + group.오프라인.cidAmt;
                totalCidQty += group.온라인.cidQty + group.오프라인.cidQty;
                totalCidCnt += group.온라인.cidCnt + group.오프라인.cidCnt;
            });
            
            const totalAmt = totalOnlineAmt + totalOfflineAmt;
            const totalQty = totalOnlineQty + totalOfflineQty;
            
            // DATA 구조 생성
            DATA = {
                total: {
                    '전체': { qty: totalQty, sales: totalAmt, colors: {}, sizes: {} },
                    '온라인': { qty: totalOnlineQty, sales: totalOnlineAmt, colors: {}, sizes: {} },
                    '오프라인': { qty: totalOfflineQty, sales: totalOfflineAmt, colors: {}, sizes: {} }
                },
                on: {
                    '온라인 전체': { qty: totalOnlineQty, sales: totalOnlineAmt, colors: {}, sizes: {} }
                },
                off: {
                    '오프라인 전체': { qty: totalOfflineQty, sales: totalOfflineAmt, colors: {}, sizes: {}, geo: {} }
                },
                cust: {
                    '회원 전체': { 
                        qty: totalQty, 
                        sales: totalAmt, 
                        colors: {}, 
                        sizes: {},
                        members: {
                            기존회원: { qty: Math.floor(totalCidQty * 0.7), sales: Math.floor(totalCidAmt * 0.7) },
                            신규회원: { qty: Math.floor(totalCidQty * 0.3), sales: Math.floor(totalCidAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    },
                    '온라인': { 
                        qty: totalOnlineQty, 
                        sales: totalOnlineAmt, 
                        colors: {}, 
                        sizes: {},
                        members: {
                            기존회원: { qty: Math.floor(totalOnlineQty * 0.7), sales: Math.floor(totalOnlineAmt * 0.7) },
                            신규회원: { qty: Math.floor(totalOnlineQty * 0.3), sales: Math.floor(totalOnlineAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    },
                    '오프라인': { 
                        qty: totalOfflineQty, 
                        sales: totalOfflineAmt, 
                        colors: {}, 
                        sizes: {},
                        members: {
                            기존회원: { qty: Math.floor(totalOfflineQty * 0.7), sales: Math.floor(totalOfflineAmt * 0.7) },
                            신규회원: { qty: Math.floor(totalOfflineQty * 0.3), sales: Math.floor(totalOfflineAmt * 0.3) }
                        },
                        ageGender: { male: {}, female: {} }
                    }
                },
                trendData: dateGroups
            };
            
            return DATA;
        }

        function renderSummaryTables() {
            if (!DATA) return;

            const formatAmt = (v) => Number(v || 0).toLocaleString();
            const formatQty = (v) => Number(v || 0).toLocaleString();
            const ratio = (v, total) => (total > 0 ? ((v / total) * 100).toFixed(1) : '0.0');

            // TOTAL
            const totalBody = document.getElementById('total-list');
            if (totalBody) {
                const tAll = DATA.total['전체'];
                const tOn = DATA.total['온라인'];
                const tOff = DATA.total['오프라인'];
                totalBody.innerHTML = `
                    <tr id="total-total-row" class="clickable-row selected-total" onclick="updateTotalDetail('전체', this)">
                        <td class="font-bold">전체</td><td>${formatAmt(tAll.sales)}</td><td>${formatQty(tAll.qty)}</td><td>100%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateTotalDetail('온라인', this)">
                        <td class="pl-5 font-semibold text-blue-600">온라인</td><td>${formatAmt(tOn.sales)}</td><td>${formatQty(tOn.qty)}</td><td>${ratio(tOn.sales, tAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateTotalDetail('오프라인', this)">
                        <td class="pl-5 font-semibold text-red-600">오프라인</td><td>${formatAmt(tOff.sales)}</td><td>${formatQty(tOff.qty)}</td><td>${ratio(tOff.sales, tAll.sales)}%</td>
                    </tr>
                `;
            }

            // ON
            const onBody = document.getElementById('on-list');
            if (onBody) {
                const onAll = DATA.on['온라인 전체'] || { sales: 0, qty: 0 };
                onBody.innerHTML = `
                    <tr id="on-total-row" class="clickable-row selected-online" onclick="updateIndicator('on', '온라인 전체', this)">
                        <td>온라인 전체</td><td>${formatAmt(onAll.sales)}</td><td>${formatQty(onAll.qty)}</td><td>100%</td>
                    </tr>
                `;
            }

            // OFF
            const offBody = document.getElementById('off-list');
            if (offBody) {
                const offAll = DATA.off['오프라인 전체'] || { sales: 0, qty: 0 };
                offBody.innerHTML = `
                    <tr id="off-total-row" class="clickable-row selected-offline" onclick="updateIndicator('off', '오프라인 전체', this)">
                        <td>오프라인 전체</td><td>${formatAmt(offAll.sales)}</td><td>${formatQty(offAll.qty)}</td><td>100%</td>
                    </tr>
                `;
            }

            // CUSTOMER
            const custBody = document.getElementById('cust-list');
            if (custBody) {
                const cAll = DATA.cust['회원 전체'];
                const cOn = DATA.cust['온라인'];
                const cOff = DATA.cust['오프라인'];
                custBody.innerHTML = `
                    <tr id="cust-total-row" class="clickable-row selected-customer" onclick="updateCustomerDetail('회원 전체', this)">
                        <td class="font-bold">회원 전체</td><td>${formatAmt(cAll.sales)}</td><td>${formatQty(cAll.qty)}</td><td>100%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateCustomerDetail('온라인', this)">
                        <td class="pl-5 font-semibold text-blue-600">온라인</td><td>${formatAmt(cOn.sales)}</td><td>${formatQty(cOn.qty)}</td><td>${ratio(cOn.sales, cAll.sales)}%</td>
                    </tr>
                    <tr class="clickable-row" onclick="updateCustomerDetail('오프라인', this)">
                        <td class="pl-5 font-semibold text-red-600">오프라인</td><td>${formatAmt(cOff.sales)}</td><td>${formatQty(cOff.qty)}</td><td>${ratio(cOff.sales, cAll.sales)}%</td>
                    </tr>
                `;
            }
        }

        async function updateDashboard() {
            // 선택된 필터 값 가져오기
            const selectedBrand = getSelectedBrand();
            const selectedPartCds = getSelectedPartCd(); // 배열로 반환됨
            const { start, end } = getSelectedDateRange();
            
            // 콘솔에 선택값 출력
            console.log('=== 필터 선택값 ===');
            console.log('브랜드:', selectedBrand);
            console.log('품번 (복수 선택):', selectedPartCds);
            console.log('시작일:', start ? start.toISOString().slice(0, 10) : '없음');
            console.log('종료일:', end ? end.toISOString().slice(0, 10) : '없음');
            console.log('==================');
            
            // 데이터가 아직 없으면 로드
            if (!dashboardData) {
                await loadData();
                // 데이터 로드 후 드롭다운 업데이트 (loadData() 내부에서도 처리되지만 확실하게)
                await updateBrandDropdown();
                updatePartCdDropdown(getSelectedBrand());
                updateDateRangeDefaults();
            }
            if (!dashboardData) {
                console.warn('dashboardData가 없어 대시보드를 그릴 수 없습니다. data/sales_daily.json 생성/배치가 필요합니다.');
                return;
            }

            // 필터링된 데이터 생성 (품번은 배열로 전달)
            const filteredData = filterRows(selectedBrand, selectedPartCds);
            console.log(`필터링된 데이터: ${filteredData.length}건 (선택된 품번: ${selectedPartCds.length}개)`);

            // DATA 객체 생성 및 화면 업데이트
            buildDATA(filteredData);
            renderSummaryTables();

            // 기본 선택 상태/배지 갱신
            states.main.selectedChannel = '전체';
            states.on.selectedChannel = '온라인 전체';
            states.off.selectedChannel = '오프라인 전체';
            states.age.selectedChannel = '회원 전체';

            if (DATA) {
                fetchAll();
                const custRow = document.getElementById('cust-total-row');
                const totalRow = document.getElementById('total-total-row');
                if (custRow) updateCustomerDetail('회원 전체', custRow);
                if (totalRow) updateTotalDetail('전체', totalRow);
            }
        }

        const states = {
            main: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '전체' },
            on: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '온라인 전체' },
            off: { metric: 'sales', view: 'daily', chart: null, selectedChannel: '오프라인 전체' },
            age: { metric: 'sales', chart: null, selectedChannel: '회원 전체' }
        };

        // API URL
        const API_URL = "https://stylecode-api-dpqrqczbz89gpmn2hnxx34.streamlit.app/";

        // 브랜드 목록 로드 (Snowflake 연동)
        async function loadBrands() {
            try {
                const res = await fetch('./data/brands.json', { cache: 'no-store' });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const { brands } = await res.json();
                console.log('브랜드 목록 로드 성공:', brands);
                
                // 브랜드 select 옵션 채우기
                const brandSelect = document.getElementById('brand');
                const errorElement = document.getElementById('brand-error');

                // 현재 UI에서는 브랜드 셀렉트를 사용하지 않음
                if (!brandSelect) {
                    return;
                }
                if (!errorElement) {
                    // error 영역이 없으면 조용히 종료
                    return;
                }
                
                if (brands && Array.isArray(brands) && brands.length > 0) {
                    // 기존 옵션 제거
                    brandSelect.innerHTML = '';
                    
                    // 브랜드 옵션 추가
                    brands.forEach((brand) => {
                        const option = document.createElement('option');
                        option.value = brand;
                        option.textContent = brand;
                        brandSelect.appendChild(option);
                    });
                    
                    // 기본값: 첫 번째 브랜드 선택
                    if (brands.length > 0) {
                        brandSelect.value = brands[0];
                    }
                    
                    // 에러 메시지 숨기기
                    errorElement.style.display = 'none';
                    
                    // loadBrands 성공 후에만 loadSales 호출
                    loadSales();
                } else {
                    throw new Error('brands 배열이 없거나 비어있음');
                }
                
            } catch (error) {
                // 콘솔에 실제 에러 출력
                console.error('브랜드 목록 로드 실패:', error);
                
                // 화면에 에러 메시지 표시
                const brandSelect = document.getElementById('brand');
                const errorElement = document.getElementById('brand-error');
                
                if (brandSelect) {
                    brandSelect.innerHTML = '<option value="">브랜드 로드 실패</option>';
                }
                if (errorElement) {
                    errorElement.style.display = 'block';
                }
            }
        }

        // 매출액 API 호출
        async function loadSales() {
            const brandEl = document.getElementById('brand');
            const startDateEl = document.getElementById('startDate');

            // 현재 UI에서는 브랜드/기간을 사용하지 않음
            if (!brandEl || !startDateEl) {
                return;
            }

            // 브랜드가 선택되지 않았으면 호출하지 않음
            const brand = brandEl.value;
            if (!brand || brand.trim() === '') {
                return;
            }
            
            try {
                const startDate = startDateEl.value;
                
                // 월 계산 (startDate가 있으면 사용, 없으면 현재 월)
                let month = '2025-12';
                if (startDate) {
                    const date = new Date(startDate);
                    month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                const url = `${API_URL}?brand=${encodeURIComponent(brand)}&month=${encodeURIComponent(month)}`;
                console.log('매출액 API 호출:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Streamlit은 HTML로 감싸서 반환하므로 텍스트로 받아서 JSON 추출
                const text = await response.text();
                console.log('응답 텍스트 (일부):', text.substring(0, 500));
                
                let data;
                try {
                    // JSON 부분만 추출 - 여러 패턴 시도
                    let jsonMatch = text.match(/\{[\s\S]*"sales_amt"[\s\S]*"generated_at"[\s\S]*?\}/);
                    if (!jsonMatch) {
                        jsonMatch = text.match(/\{[\s\S]*"sales_amt"[\s\S]*?\}/);
                    }
                    if (!jsonMatch) {
                        jsonMatch = text.match(/\{[\s\S]*?\}/);
                    }
                    
                    if (jsonMatch) {
                        data = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('JSON을 찾을 수 없음');
                    }
                } catch (parseError) {
                    console.error('JSON 파싱 실패:', parseError);
                    console.error('원본 텍스트 (일부):', text.substring(0, 1000));
                    throw new Error('JSON 파싱 실패: ' + parseError.message);
                }
                
                console.log('파싱된 데이터:', data);
                
                // KPI 카드 업데이트 (요소가 존재하는 경우에만)
                const salesAmtElement = document.getElementById('kpi-sales-amt');
                const errorElement = document.getElementById('kpi-error');
                
                if (data && data.sales_amt !== undefined) {
                    if (salesAmtElement) {
                        // 숫자 포맷팅 (천 단위 구분)
                        const formattedAmount = new Intl.NumberFormat('ko-KR').format(data.sales_amt);
                        salesAmtElement.textContent = formattedAmount + '원';
                    }
                    if (errorElement) {
                        errorElement.style.display = 'none';
                    }
                } else {
                    throw new Error('sales_amt 필드가 없음');
                }
                
            } catch (error) {
                // 콘솔에만 상세 에러 로그 출력
                console.error('매출액 로드 실패:', error);
                console.error('에러 상세:', error.message, error.stack);
                
                // 화면에는 간단한 메시지만 표시 (요소가 존재하는 경우에만)
                const salesAmtElement = document.getElementById('kpi-sales-amt');
                const errorElement = document.getElementById('kpi-error');
                
                if (salesAmtElement) {
                    salesAmtElement.textContent = '-';
                }
                if (errorElement) {
                    errorElement.style.display = 'block';
                }
            }
        }

        // DOMContentLoaded 이후에 실행
        document.addEventListener('DOMContentLoaded', async function() {
            // 날짜 기본값 설정: 시작일 = 오늘-30일, 종료일 = 오늘
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            if (startEl && endEl) {
                const today = new Date();
                const startDate = new Date();
                startDate.setDate(today.getDate() - 30);
                
                startEl.value = startDate.toISOString().slice(0, 10);
                endEl.value = today.toISOString().slice(0, 10);
            }

            // 품번 드롭다운에만 select2 적용 (브랜드는 updateBrandDropdown에서 초기화)
            if (window.jQuery) {
                $('.js-part-filter').select2({ 
                    placeholder: "품번 선택 (복수 선택 가능)", 
                    allowClear: true,
                    multiple: true,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "검색 결과가 없습니다.";
                        },
                        searching: function() {
                            return "검색 중...";
                        }
                    }
                });
            }

            // 브랜드 드롭다운 변경 이벤트
            const brandSelect = document.getElementById('brand-filter');
            if (brandSelect) {
                brandSelect.addEventListener('change', async () => {
                    const selectedBrand = getSelectedBrand();
                    // 브랜드 변경 시 PART_CD 드롭다운 업데이트 (선택 초기화)
                    const partSelect = document.getElementById('part-filter');
                    if (partSelect) {
                        // Select2 multiple인 경우 모든 선택 해제
                        if (window.jQuery && jQuery(partSelect).data('select2')) {
                            jQuery(partSelect).val(null).trigger('change.select2');
                        } else {
                            // 일반 select인 경우
                            Array.from(partSelect.options).forEach(opt => opt.selected = false);
                        }
                    }
                    // 해당 브랜드의 품번만 표시하도록 업데이트
                    updatePartCdDropdown(selectedBrand);
                    // 자동 업데이트는 하지 않고, 조회하기 버튼을 눌러야 업데이트
                });
            }

            // PART_CD 변경 시 (조회하기 버튼을 눌러야 실제 반영)
            const partSelect = document.getElementById('part-filter');
            if (partSelect) {
                partSelect.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }

            // 날짜 변경 시 (조회하기 버튼을 눌러야 실제 반영)
            if (startEl) {
                startEl.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }
            if (endEl) {
                endEl.addEventListener('change', () => {
                    // 조회하기 버튼을 눌러야 실제 반영되므로 여기서는 아무것도 하지 않음
                });
            }

            // 데이터 로드 (내부에서 updateBrandDropdown() -> updatePartCdDropdown() -> updateDashboard() 자동 호출)
            await loadData();
        });

        function setChart(key, type, val) {
            states[key][type] = val;
            $(`[id^="${key}-${type === 'metric' ? 'sales' : 'daily'}"]`).parent().find('button').removeClass('btn-active').addClass('btn-inactive');
            $(`#${key}-${val}`).addClass('btn-active').removeClass('btn-inactive');
            renderSingleChart(key);
        }

        function updateIndicator(type, name, rowElement) {
            const container = document.getElementById(`${type}-list`);
            Array.from(container.querySelectorAll('tr')).forEach(r => r.classList.remove(type === 'on' ? 'selected-online' : 'selected-offline'));
            if(rowElement) rowElement.classList.add(type === 'on' ? 'selected-online' : 'selected-offline');

            document.getElementById(`${type}-t-color`).innerText = name;
            document.getElementById(`${type}-t-size`).innerText = name;
            
            const d = DATA[type][name] || DATA[type][type === 'on' ? '온라인 전체' : '오프라인 전체'];
            fillTable(`${type}-color-body`, d.colors, d.qty);
            fillTable(`${type}-size-body`, d.sizes, d.qty);
            
            states[type].selectedChannel = name;
            document.getElementById(`${type}-chart-title`).innerText = `${type.toUpperCase()} TREND: ${name}`;
            renderSingleChart(type);

            if(type === 'off') {
                document.getElementById('off-t-region').innerText = name;
                document.getElementById('off-t-shop').innerText = name;
                updateShopRank(name);
                updateRegionTable(d.geo, d.qty);
            }
        }

        function updateTotalDetail(name, rowElement) {
            $('#total-list tr').removeClass('selected-total');
            $(rowElement).addClass('selected-total');
            $('#total-t-color').text(name);
            $('#total-t-size').text(name);
            
            const d = DATA.total[name] || DATA.total['전체'];
            fillTable('total-color-body', d.colors, d.qty);
            fillTable('total-size-body', d.sizes, d.qty);
            
            // 통합 매출 그래프 업데이트
            states.main.selectedChannel = name;
            document.getElementById('main-chart-title').innerText = `TOTAL TREND: ${name}`;
            renderSingleChart('main');
        }

        function updateCustomerDetail(name, rowElement) {
            $('#cust-list tr').removeClass('selected-customer');
            $(rowElement).addClass('selected-customer');
            $('#cust-t-color').text(name);
            $('#cust-t-size').text(name);
            
            // 회원 구분 배지 업데이트 (제목은 "기존/신규 회원"으로 고정)
            let displayName = name;
            if (!name.includes('전체') && name !== '자사몰') {
                displayName = name + ' 전체';
            }
            $('#cust-t-member').text(displayName);
            
            const d = DATA.cust[name];
            fillTable('cust-color-body', d.colors, d.qty);
            fillTable('cust-size-body', d.sizes, d.qty);
            fillMemberTable('cust-member-body', d.members, d.qty, d.sales, name);
            
            // 연령대 그래프 업데이트
            states.age.selectedChannel = name;
            renderAgeChart();
        }

        function fillMemberTable(id, members, totalQty, totalSales, channelName) {
            const b = document.getElementById(id);
            b.innerHTML = '';
            
            // SUM 행 추가 (선택한 채널명 표시)
            b.innerHTML += `<tr class="font-black bg-purple-50">
                <td>${channelName}</td>
                <td>${totalSales.toLocaleString()}</td>
                <td>${totalQty.toLocaleString()}</td>
                <td class="text-purple-600">100.0%</td>
            </tr>`;
            
            // 기존회원, 신규회원 행 추가
            Object.entries(members).forEach(([memberType, data]) => {
                const qtyRatio = ((data.qty / totalQty) * 100).toFixed(1);
                b.innerHTML += `<tr>
                    <td class="font-bold">${memberType}</td>
                    <td>${data.sales.toLocaleString()}</td>
                    <td>${data.qty.toLocaleString()}</td>
                    <td class="text-slate-400">${qtyRatio}%</td>
                </tr>`;
            });
        }

        function fillTable(id, obj, total) {
            const b = document.getElementById(id); b.innerHTML = '';
            Object.entries(obj).forEach(([k, v]) => {
                b.innerHTML += `<tr><td>${k}</td><td class="font-bold">${v.toLocaleString()}</td><td class="text-slate-400">${((v/total)*100).toFixed(1)}%</td></tr>`;
            });
        }

        function updateShopRank(channel) {
            const body = document.getElementById('shop-rank-body'); body.innerHTML = '';
            body.innerHTML = `<tr><td colspan="4" class="text-slate-400 font-bold text-center py-6">매장 랭킹 데이터가 없습니다.</td></tr>`;
        }

        function updateRegionTable(geoData, totalQty) {
            const body = document.getElementById('region-rank-body'); body.innerHTML = '';
            Object.entries(geoData).forEach(([region, qty]) => {
                const sales = qty * 75000;
                body.innerHTML += `<tr><td class="font-bold">${region}</td><td>${sales.toLocaleString()}원</td><td>${qty.toLocaleString()}</td><td class="text-blue-600 font-black">${((qty/totalQty)*100).toFixed(1)}%</td></tr>`;
            });
        }

        function renderSingleChart(key) {
            const canvasEl = document.getElementById(`${key}Chart`);
            if(!canvasEl) return;
            const s = states[key];
            if (s.chart) s.chart.destroy();

            // trendData 기반 시계열 생성
            const trend = (DATA && DATA.trendData) ? DATA.trendData : {};
            const entries = Object.entries(trend)
                .map(([rawDate, v]) => ({ rawDate, date: parseSaleDate(rawDate) || parseSaleDate(v?.date) }))
                .filter(x => x.date != null)
                .sort((a, b) => a.date - b.date);

            const metricKey = s.metric === 'sales' ? 'amt' : 'qty';

            function pickChannelVal(group, channelType) {
                if (!group || !group[channelType]) return 0;
                return Number(group[channelType][metricKey] || 0);
            }

            function buildSeries(channelType) {
                if (s.view === 'daily') {
                    const sliced = entries.slice(-14);
                    const labels = sliced.map(e => formatDateLabel(e.date));
                    const data = sliced.map(e => pickChannelVal(trend[e.rawDate], channelType));
                    return { labels, data };
                }
                if (s.view === 'weekly') {
                    const bucket = new Map();
                    entries.forEach(e => {
                        const key = getWeekKey(e.date);
                        bucket.set(key, (bucket.get(key) || 0) + pickChannelVal(trend[e.rawDate], channelType));
                    });
                    const keys = [...bucket.keys()].sort();
                    return { labels: keys.slice(-12), data: keys.slice(-12).map(k => bucket.get(k) || 0) };
                }
                // monthly
                const bucket = new Map();
                entries.forEach(e => {
                    const key = getMonthKey(e.date);
                    bucket.set(key, (bucket.get(key) || 0) + pickChannelVal(trend[e.rawDate], channelType));
                });
                const keys = [...bucket.keys()].sort();
                return { labels: keys.slice(-12), data: keys.slice(-12).map(k => bucket.get(k) || 0) };
            }

            let labels = [];
            let ds = [];

            if (key === 'main') {
                const channel = s.selectedChannel || '전체';
                if (channel === '전체') {
                    const onSeries = buildSeries('온라인');
                    const offSeries = buildSeries('오프라인');
                    labels = onSeries.labels.length ? onSeries.labels : offSeries.labels;
                    ds = [
                        { label: 'ONLINE TOTAL', data: onSeries.data, borderColor: '#2563eb', tension: 0.4, borderWidth: 2, pointRadius: 2 },
                        { label: 'OFFLINE TOTAL', data: offSeries.data, borderColor: '#dc2626', tension: 0.4, borderWidth: 2, pointRadius: 2 }
                    ];
                } else if (channel === '온라인') {
                    const onSeries = buildSeries('온라인');
                    labels = onSeries.labels;
                    ds = [{ label: 'ONLINE TOTAL', data: onSeries.data, borderColor: '#2563eb', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                } else if (channel === '오프라인') {
                    const offSeries = buildSeries('오프라인');
                    labels = offSeries.labels;
                    ds = [{ label: 'OFFLINE TOTAL', data: offSeries.data, borderColor: '#dc2626', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
                }
            } else if (key === 'on') {
                const onSeries = buildSeries('온라인');
                labels = onSeries.labels;
                ds = [{ label: 'ONLINE', data: onSeries.data, borderColor: '#3b82f6', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
            } else if (key === 'off') {
                const offSeries = buildSeries('오프라인');
                labels = offSeries.labels;
                ds = [{ label: 'OFFLINE', data: offSeries.data, borderColor: '#ef4444', tension: 0.4, borderWidth: 2, pointRadius: 2 }];
            }

            s.chart = new Chart(canvasEl.getContext('2d'), {
                type: 'line',
                data: { labels, datasets: ds },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function setAgeChart(metric) {
            states.age.metric = metric;
            $('#age-sales, #age-qty').removeClass('btn-active').addClass('btn-inactive');
            $(`#age-${metric}`).addClass('btn-active').removeClass('btn-inactive');
            renderAgeChart();
        }

        function renderAgeChart() {
            const canvasEl = document.getElementById('ageChart');
            if(!canvasEl) return;
            const s = states.age;
            if (s.chart) s.chart.destroy();

            const ageLabels = ['15-19', '20-24', '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59', '60~'];
            const channelName = s.selectedChannel || '회원 전체';
            const d = DATA.cust[channelName];
            
            if (!d || !d.ageGender) return;

            const maleData = ageLabels.map(age => {
                const data = d.ageGender.male[age] || {qty: 0, sales: 0};
                return s.metric === 'sales' ? data.sales : data.qty;
            });

            const femaleData = ageLabels.map(age => {
                const data = d.ageGender.female[age] || {qty: 0, sales: 0};
                return s.metric === 'sales' ? data.sales : data.qty;
            });

            s.chart = new Chart(canvasEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ageLabels,
                    datasets: [
                        {
                            label: '남성',
                            data: maleData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 2
                        },
                        {
                            label: '여성',
                            data: femaleData,
                            backgroundColor: 'rgba(236, 72, 153, 0.7)',
                            borderColor: '#ec4899',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return context.dataset.label + ': ' + (s.metric === 'sales' ? value.toLocaleString() + '원' : value.toLocaleString());
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return s.metric === 'sales' ? (value / 1000000).toFixed(0) + 'M' : value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function fetchAll() { 
            renderSingleChart('main'); renderSingleChart('on'); renderSingleChart('off'); 
            updateIndicator('on', states.on.selectedChannel, null);
            updateIndicator('off', states.off.selectedChannel, null);
            renderAgeChart();
            document.getElementById('main-chart-title').innerText = `TOTAL TREND: ${states.main.selectedChannel || '전체'}`;
        }
    </script>
</body>
</html>